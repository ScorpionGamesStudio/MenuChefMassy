<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0b0b0f" />
    <title>Menu della Serata • Casa Edition</title>

    <style>
        :root {
            --bg: #07070a;
            --bg2: #0a0a12;
            --panel: rgba(255,255,255,.06);
            --panel2: rgba(255,255,255,.08);
            --border: rgba(255,255,255,.12);
            --text: rgba(255,255,255,.92);
            --muted: rgba(255,255,255,.66);
            --gold1: #f6d365;
            --gold2: #d6ae54;
            --accent: #caa24a;
            --shadow: 0 24px 80px rgba(0,0,0,.55);
            --radius: 18px;
            --radius2: 26px;
            --max: 1180px;
            --danger: #ff5b6b;
            --ok: #38d6a5;
        }

        body.light {
            --bg: #f7f5f0;
            --bg2: #ffffff;
            --panel: rgba(0,0,0,.04);
            --panel2: rgba(0,0,0,.06);
            --border: rgba(0,0,0,.10);
            --text: rgba(0,0,0,.88);
            --muted: rgba(0,0,0,.62);
            --shadow: 0 20px 60px rgba(0,0,0,.12);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
            color: var(--text);
            background: radial-gradient(1200px 600px at 15% -10%, rgba(246,211,101,.20), transparent 60%), radial-gradient(900px 500px at 90% 10%, rgba(202,162,74,.18), transparent 55%), radial-gradient(800px 500px at 50% 110%, rgba(120,90,200,.10), transparent 55%), linear-gradient(180deg, var(--bg) 0%, var(--bg2) 40%, var(--bg) 100%);
            overflow-x: hidden;
        }

            body.modal-open {
                overflow: hidden;
                height: 100%;
            }

        .wrap {
            max-width: var(--max);
            margin: 0 auto;
            padding: 26px 18px 90px;
        }

        /* Top bar */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
            border-radius: var(--radius2);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 10px;
            z-index: 50;
            flex-wrap: wrap;
        }

        body.light .topbar {
            background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.70));
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            background: radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.35), transparent 60%), linear-gradient(135deg, rgba(246,211,101,.95), rgba(202,162,74,.80));
            box-shadow: 0 12px 30px rgba(202,162,74,.25);
            position: relative;
        }

            .logo:after {
                content: "";
                position: absolute;
                inset: 10px;
                border-radius: 12px;
                border: 1px solid rgba(0,0,0,.22);
                background: rgba(0,0,0,.08);
            }

        .brand h1 {
            font-size: 12px;
            margin: 0;
            letter-spacing: .28em;
            text-transform: uppercase;
            color: rgba(255,255,255,.88);
        }

        body.light .brand h1 {
            color: rgba(0,0,0,.78);
        }

        .brand .sub {
            font-size: 12px;
            margin-top: 2px;
            color: var(--muted);
            letter-spacing: .02em;
        }

        .chef {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 14px;
            border: 1px solid rgba(246,211,101,.22);
            background: rgba(202,162,74,.10);
            backdrop-filter: blur(8px);
            margin-left: auto;
            min-width: 220px;
        }

        .chefLabel {
            font-size: 10px;
            letter-spacing: .26em;
            text-transform: uppercase;
            color: rgba(255,255,255,.72);
        }

        .chefName {
            font-size: 12px;
            letter-spacing: .06em;
            color: rgba(255,255,255,.92);
            font-weight: 600;
        }

        body.light .chef {
            background: rgba(0,0,0,.03);
            border-color: rgba(0,0,0,.10);
        }

        body.light .chefLabel {
            color: rgba(0,0,0,.60);
        }

        body.light .chefName {
            color: rgba(0,0,0,.80);
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }

        .btn {
            border: 1px solid var(--border);
            background: rgba(255,255,255,.05);
            color: rgba(255,255,255,.84);
            padding: 10px 12px;
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
            transition: transform .12s ease, background .12s ease, border-color .12s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            white-space: nowrap;
        }

        body.light .btn {
            background: rgba(0,0,0,.03);
            color: rgba(0,0,0,.78);
        }

        .btn:hover {
            transform: translateY(-1px);
            background: rgba(255,255,255,.07);
            border-color: rgba(246,211,101,.35);
        }

        body.light .btn:hover {
            background: rgba(0,0,0,.05);
        }

        .btn.danger {
            border-color: rgba(255,91,107,.35);
        }

            .btn.danger:hover {
                border-color: rgba(255,91,107,.55);
            }

        .btn.ok {
            border-color: rgba(56,214,165,.35);
        }

            .btn.ok:hover {
                border-color: rgba(56,214,165,.55);
            }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: linear-gradient(180deg, var(--gold1), var(--gold2));
            box-shadow: 0 0 0 4px rgba(202,162,74,.12);
        }

        .ico {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: -3px;
        }

        @media (max-width: 720px) {
            .chef {
                order: 3;
                width: 100%;
                text-align: left;
                margin-left: 0;
                min-width: unset;
            }

            .actions {
                order: 4;
                width: 100%;
                justify-content: flex-start;
            }
        }

        /* Cover */
        .cover {
            margin-top: 18px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
            border-radius: var(--radius2);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
        }

        body.light .cover {
            background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.76));
        }

        .cover:before {
            content: "";
            position: absolute;
            inset: -2px;
            background: radial-gradient(620px 200px at 18% 0%, rgba(246,211,101,.18), transparent 60%), radial-gradient(620px 200px at 82% 0%, rgba(202,162,74,.14), transparent 60%);
            pointer-events: none;
        }

        .coverInner {
            position: relative;
            padding: 20px;
            display: grid;
            grid-template-columns: 1.2fr .8fr;
            gap: 16px;
            align-items: stretch;
        }

        @media (max-width: 960px) {
            .coverInner {
                grid-template-columns: 1fr;
            }
        }

        .headline {
            margin: 0;
            font-size: clamp(28px, 3.4vw, 46px);
            line-height: 1.06;
            letter-spacing: -0.02em;
        }

            .headline .gold {
                background: linear-gradient(135deg, var(--gold1), var(--gold2));
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
                text-shadow: 0 18px 60px rgba(202,162,74,.12);
            }

        .lede {
            margin: 10px 0 0;
            color: var(--muted);
            font-size: 14px;
            line-height: 1.6;
            max-width: 72ch;
            white-space: normal;
        }

        .metaGrid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 14px;
        }

        @media (max-width: 520px) {
            .metaGrid {
                grid-template-columns: 1fr;
            }
        }

        .metaCard {
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.04);
            border-radius: 16px;
            padding: 12px;
        }

        body.light .metaCard {
            border-color: rgba(0,0,0,.10);
            background: rgba(0,0,0,.03);
        }

        .metaCard b {
            display: block;
            font-size: 12px;
            letter-spacing: .18em;
            text-transform: uppercase;
            opacity: .9;
        }

        .metaCard span {
            display: block;
            margin-top: 6px;
            color: var(--muted);
            font-size: 12px;
            line-height: 1.45;
        }

        .toastNote {
            border: 1px solid rgba(246,211,101,.22);
            background: rgba(202,162,74,.10);
            border-radius: 18px;
            padding: 14px;
            height: 100%;
        }

            .toastNote h3 {
                margin: 0;
                font-size: 13px;
                letter-spacing: .22em;
                text-transform: uppercase;
            }

            .toastNote p {
                margin: 10px 0 0;
                color: var(--muted);
                font-size: 13px;
                line-height: 1.6;
                white-space: normal;
            }

        body.light .toastNote p {
            color: rgba(0,0,0,.62);
        }

        /* Sections */
        .section {
            margin-top: 18px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
            border-radius: var(--radius2);
            overflow: hidden;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            position: relative;
        }

        body.light .section {
            background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
        }

        .sectionHead {
            padding: 16px 18px;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.03);
        }

        body.light .sectionHead {
            border-bottom-color: rgba(0,0,0,.08);
            background: rgba(0,0,0,.02);
        }

        .sectionHead h2 {
            margin: 0;
            font-size: 13px;
            letter-spacing: .26em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sectionHead .desc {
            margin: 0;
            color: var(--muted);
            font-size: 12px;
        }

        .sectionActions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .miniBtn {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: 1px solid rgba(246,211,101,.22);
            background: rgba(202,162,74,.10);
            color: rgba(255,255,255,.92);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform .12s ease, border-color .12s ease, background .12s ease;
            user-select: none;
            font-size: 18px;
            line-height: 1;
        }

            .miniBtn:hover {
                transform: translateY(-1px);
                border-color: rgba(246,211,101,.35);
                background: rgba(202,162,74,.16);
            }

        body.light .miniBtn {
            background: rgba(0,0,0,.03);
            border-color: rgba(0,0,0,.10);
            color: rgba(0,0,0,.78);
        }

            body.light .miniBtn:hover {
                background: rgba(0,0,0,.05);
                border-color: rgba(0,0,0,.16);
            }

        .grid {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 14px;
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 560px) {
            .grid {
                grid-template-columns: repeat(1, 1fr);
            }
        }

        .card {
            grid-column: span 4;
            border: 1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.04);
            border-radius: var(--radius);
            overflow: hidden;
            transition: transform .12s ease, border-color .12s ease, background .12s ease;
            position: relative;
        }

        body.light .card {
            border-color: rgba(0,0,0,.10);
            background: rgba(0,0,0,.02);
        }

        @media (max-width: 980px) {
            .card {
                grid-column: span 6;
            }
        }

        @media (max-width: 560px) {
            .card {
                grid-column: span 1;
            }
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(246,211,101,.28);
            background: rgba(255,255,255,.055);
        }

        body.light .card:hover {
            background: rgba(0,0,0,.04);
        }

        /* Immagini: niente tagli */
        .img {
            height: 230px;
            background: rgba(0,0,0,.20);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.light .img {
            background: rgba(0,0,0,.04);
        }

        .img img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
            display: block;
            filter: contrast(1.04) saturate(1.05);
            transform: none;
        }

        .cardBtnsRight {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
            gap: 8px;
            z-index: 3;
        }

        body.admin .cardBtnsRight {
            display: flex;
        }

        .dragBtnWrap {
            position: absolute;
            top: 10px;
            left: 10px;
            display: none;
            z-index: 3;
        }

        body.admin .dragBtnWrap {
            display: block;
        }

        .editBtn, .delBtn, .dragBtn {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: transform .12s ease, border-color .12s ease, background .12s ease;
            font-size: 16px;
            line-height: 1;
            color: rgba(255,255,255,.92);
            border: 1px solid rgba(246,211,101,.28);
            background: rgba(202,162,74,.14);
            backdrop-filter: blur(6px);
        }

        .dragBtn {
            font-size: 18px;
            cursor: grab;
        }

            .dragBtn:active {
                cursor: grabbing;
            }

            .editBtn:hover, .dragBtn:hover {
                transform: translateY(-1px);
                border-color: rgba(246,211,101,.45);
                background: rgba(202,162,74,.20);
            }

        .delBtn {
            border: 1px solid rgba(255,91,107,.35);
            background: rgba(255,91,107,.14);
            font-size: 18px;
        }

            .delBtn:hover {
                transform: translateY(-1px);
                border-color: rgba(255,91,107,.55);
                background: rgba(255,91,107,.20);
            }

        body.light .editBtn, body.light .dragBtn {
            color: rgba(0,0,0,.85);
            background: rgba(0,0,0,.03);
            border-color: rgba(0,0,0,.10);
        }

        body.light .delBtn {
            color: rgba(0,0,0,.85);
        }

        /* durante drag: la card rimane nel layout ma invisibile */
        .card.dragging {
            opacity: 0;
        }

        /* Placeholder che indica dove verrà depositata la card */
        .dropMarker {
            grid-column: span 4;
            border-radius: var(--radius);
            border: 2px dashed rgba(246,211,101,.55);
            background: rgba(202,162,74,.08);
            min-height: 260px;
        }

        @media (max-width: 980px) {
            .dropMarker {
                grid-column: span 6;
            }
        }

        @media (max-width: 560px) {
            .dropMarker {
                grid-column: span 1;
            }
        }

        .content {
            padding: 14px 14px 16px;
        }

        .name {
            margin: 0;
            font-size: 15px;
            letter-spacing: -0.01em;
        }

        /* FIX a-capo: usa CSS */
        .info {
            margin: 8px 0 0;
            color: rgba(255,255,255,.72);
            font-size: 12px;
            line-height: 1.55;
            white-space: pre-wrap;
            overflow-wrap: anywhere;
        }

        body.light .info {
            color: rgba(0,0,0,.62);
        }

        .grid.center-few {
            grid-template-columns: repeat(var(--cols, 1), minmax(280px, 360px));
            justify-content: center;
            justify-items: stretch;
        }

            .grid.center-few .card {
                grid-column: auto;
                max-width: 360px;
                width: 100%;
            }

        @media (max-width: 980px) {
            .grid.center-few {
                grid-template-columns: 1fr;
                justify-content: stretch;
            }

                .grid.center-few .card {
                    max-width: none;
                }
        }

        /* Floating save (admin) */
        .saveFloat {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 200;
            display: none;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        body.admin .saveFloat {
            display: flex;
        }

        .pill {
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.26);
            backdrop-filter: blur(10px);
            color: rgba(255,255,255,.82);
            border-radius: 999px;
            padding: 10px 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.light .pill {
            background: rgba(255,255,255,.8);
            color: rgba(0,0,0,.75);
            border-color: rgba(0,0,0,.10);
        }

        /* Modal */
        .modalBack {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.62);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 999;
        }

            .modalBack.show {
                display: flex;
            }

        .modal {
            width: min(860px, 100%);
            border: 1px solid rgba(255,255,255,.14);
            background: linear-gradient(180deg, rgba(20,20,30,.88), rgba(10,10,16,.88));
            border-radius: 22px;
            box-shadow: 0 40px 120px rgba(0,0,0,.65);
            overflow: hidden;
            backdrop-filter: blur(10px);
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        body.light .modal {
            background: rgba(255,255,255,.95);
            border-color: rgba(0,0,0,.12);
        }

        .modalHead {
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.03);
            flex: 0 0 auto;
        }

        body.light .modalHead {
            border-bottom-color: rgba(0,0,0,.08);
            background: rgba(0,0,0,.02);
        }

        .modalHead h3 {
            margin: 0;
            font-size: 13px;
            letter-spacing: .22em;
            text-transform: uppercase;
        }

        .modalBody {
            padding: 16px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1 1 auto;
            max-height: calc(100vh - 40px - 60px);
        }

        .panel {
            border: 1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.04);
            border-radius: 18px;
            padding: 14px;
        }

        body.light .panel {
            border-color: rgba(0,0,0,.10);
            background: rgba(0,0,0,.02);
        }

        .row {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        @media (max-width: 720px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        label {
            font-size: 12px;
            letter-spacing: .18em;
            text-transform: uppercase;
            color: rgba(255,255,255,.80);
        }

        body.light label {
            color: rgba(0,0,0,.70);
        }

        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.18);
            color: var(--text);
            outline: none;
        }

        body.light input[type="text"], body.light input[type="password"], body.light textarea {
            background: rgba(255,255,255,.75);
            color: rgba(0,0,0,.85);
            border-color: rgba(0,0,0,.10);
        }

        textarea {
            min-height: 90px;
            resize: vertical;
            white-space: pre-wrap;
        }

        .mini {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.5;
            margin-top: 10px;
        }

        .right {
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .fileRow {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .fileActions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .thumb {
            width: 100%;
            height: 160px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.16);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

        body.light .thumb {
            background: rgba(0,0,0,.02);
            border-color: rgba(0,0,0,.10);
        }

        @media print {
            .topbar, .actions, .saveFloat {
                display: none !important;
            }

            body {
                background: white !important;
            }

            .wrap {
                padding: 0;
            }

            .section, .cover {
                box-shadow: none !important;
            }

            .chef {
                display: none !important;
            }

            .modalBack {
                display: none !important;
            }

            .cardBtnsRight, .dragBtnWrap {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header class="topbar">
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div>
                    <h1>Menu della Serata</h1>
                    <div class="sub"><span style="letter-spacing:.08em;">Casa Edition</span></div>
                </div>
            </div>

            <div class="chef" aria-label="Chef">
                <span class="chefLabel">Chef della serata</span>
                <span class="chefName" id="chefNameTop">Massimiliano Giannone</span>
            </div>

            <div class="actions">
                <button class="btn" id="toggleTheme" type="button" title="Modalità chiara/scura">
                    <span class="dot" aria-hidden="true"></span>
                    Modalità
                </button>

                <button class="btn" id="printBtn" type="button" title="Stampa o salva in PDF">
                    <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M7 8V4h10v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                        <path d="M7 17h10v3H7v-3Z" stroke="currentColor" stroke-width="1.8" />
                        <path d="M6 10h12a2 2 0 0 1 2 2v3h-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                        <path d="M7 15H4v-3a2 2 0 0 1 2-2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                    </svg>
                    PDF / Stampa
                </button>

                <button class="btn" id="editEventBtn" type="button" title="Modifica evento (solo admin)" style="display:none;">
                    ✏️ Modifica evento
                </button>

                <button class="btn" id="adminBtn" type="button" title="Apri modalità admin">
                    <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 3l7 4v6c0 5-3 8-7 8s-7-3-7-8V7l7-4Z" stroke="currentColor" stroke-width="1.8" />
                        <path d="M12 10v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                        <path d="M12 16h.01" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" />
                    </svg>
                    Admin
                </button>

                <button class="btn danger" id="logoutBtn" type="button" title="Logout (solo admin)" style="display:none;">
                    Logout
                </button>
            </div>
        </header>

        <section class="cover" aria-label="Copertina evento">
            <div class="coverInner">
                <div>
                    <h2 class="headline">
                        <span id="heroPrefix">Stasera a casa con Chef Massy:</span>
                        <span class="gold" id="heroGold">cena da 3 stelle</span>
                    </h2>

                    <p class="lede" id="heroDesc">
                        Un menu completo, elegante e moderno.
                        Presentato in modo “wow” come fosse un fine-dining,
                        ma con il calore di una serata tra amici e famiglia.
                    </p>

                    <div class="metaGrid" aria-label="Dettagli serata">
                        <div class="metaCard">
                            <b>Data & Orario</b>
                            <span id="metaOrario">06/01/2026<br />alle ore 20:30</span>
                        </div>
                        <div class="metaCard">
                            <b>Note</b>
                            <span id="metaNote">Chiedimi per allergeni o alternative.<br />Piatti serviti “a ondate”.</span>
                        </div>
                    </div>
                </div>

                <aside class="toastNote" aria-label="Dettagli serata">
                    <h3>Dettagli serata</h3>
                    <p id="toastText">—</p>
                </aside>
            </div>
        </section>

        <div id="menuRoot"></div>
    </div>

    <div class="saveFloat" id="saveFloat">
        <div class="pill" id="dirtyPill" style="display:none;">
            <span class="dot" aria-hidden="true"></span>
            Modifiche non salvate
        </div>

        <button class="btn ok" id="saveAllBtn" type="button" title="Salva + scarica menu-data.json">Salva</button>
    </div>

    <div class="modalBack" id="modalBack" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modalHead">
                <h3 id="modalTitle">—</h3>
                <button class="btn danger" id="modalClose" type="button">Chiudi</button>
            </div>
            <div class="modalBody" id="modalBody"></div>
        </div>
    </div>

    <script>
        /******************************************************************
         * CONFIG
         ******************************************************************/
        const ADMIN_USERNAME = "admin";
        const ADMIN_PASSWORD = "1234";

        const REMOTE_DATA_FILE = "menu-data.json";

        const SESSION_KEY = "menu_admin_session_v12";
        const MENU_KEY = "menu_data_v12_localcache";

        // ✅ cartella immagini (come la vuoi tu)
        const IMAGES_FOLDER = "immage/"; // <-- crea questa cartella nella repo

        let MENU = null;
        let DRAFT = null;
        let DIRTY = false;

        function $(id) { return document.getElementById(id); }

        function escapeXml(s) {
            return String(s ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        function safeParseJson(txt) {
            try { return JSON.parse(txt); } catch { return null; }
        }
        function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

        function setDirty(v) {
            DIRTY = v;
            $("dirtyPill").style.display = DIRTY ? "flex" : "none";
        }

        function stopWheelChaining(e) {
            const el = $("modalBody");
            const delta = e.deltaY;
            const atTop = el.scrollTop <= 0;
            const atBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 1;
            if ((delta < 0 && atTop) || (delta > 0 && atBottom)) e.preventDefault();
        }

        function openModal(title, html) {
            $("modalTitle").textContent = title;
            $("modalBody").innerHTML = html;

            $("modalBack").classList.add("show");
            $("modalBack").setAttribute("aria-hidden", "false");
            document.body.classList.add("modal-open");

            $("modalBody").scrollTop = 0;
            $("modalBody").addEventListener("wheel", stopWheelChaining, { passive: false });
        }

        function closeModal() {
            $("modalBack").classList.remove("show");
            $("modalBack").setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            $("modalBody").removeEventListener("wheel", stopWheelChaining);
            $("modalBody").innerHTML = "";
        }

        function nlToBr(s) {
            const v = String(s ?? "").replace(/\r\n/g, "\n");
            return v.split("\n").map(x => x.trimEnd()).join("<br/>");
        }

        function brToNl(s) {
            return String(s ?? "")
                .replaceAll("<br/>", "\n")
                .replaceAll("<br>", "\n")
                .replaceAll("<br />", "\n");
        }

        function placeholderSvg(title) {
            return `data:image/svg+xml;utf8,
                    <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
                      <defs>
                        <linearGradient id="g" x1="0" x2="1">
                          <stop offset="0" stop-color="%2307070a"/>
                          <stop offset="1" stop-color="%23151622"/>
                        </linearGradient>
                        <radialGradient id="r" cx="25%" cy="20%" r="70%">
                          <stop offset="0" stop-color="%23f6d365" stop-opacity="0.20"/>
                          <stop offset="1" stop-color="%23d6ae54" stop-opacity="0"/>
                        </radialGradient>
                      </defs>
                      <rect width="100%" height="100%" fill="url(%23g)"/>
                      <circle cx="320" cy="170" r="420" fill="url(%23r)"/>
                      <rect x="120" y="210" width="960" height="460" rx="48" fill="%23ffffff" fill-opacity="0.06" stroke="%23ffffff" stroke-opacity="0.12"/>
                      <text x="160" y="350" font-size="54" fill="%23ffffff" fill-opacity="0.92" font-family="Arial">${escapeXml(title || "Piatto")}</text>
                      <text x="160" y="420" font-size="28" fill="%23ffffff" fill-opacity="0.62" font-family="Arial">foto in arrivo ✨</text>
                    </svg>`;
        }

        // ✅ Normalizza URL immagini:
        // - data:/http(s)/blob => ok
        // - altrimenti => trattalo come path relativo (es: immage/coca.jpg)
        function resolveImageSrc(imageUrl, fallbackTitle) {
            const v = String(imageUrl || "").trim();
            if (!v) return placeholderSvg(fallbackTitle || "Piatto");
            if (v.startsWith("data:image/") || v.startsWith("http://") || v.startsWith("https://") || v.startsWith("blob:")) return v;
            return v; // relativo (es: immage/xxx.jpg)
        }

        /******************************************************************
         * ID UTILS (per riordinare le schede)
         ******************************************************************/
        function genId() {
            try {
                if (typeof crypto !== "undefined" && crypto.randomUUID) return crypto.randomUUID();
            } catch (e) { }
            return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
        }

        function ensureItemIds(menu) {
            if (!menu || !menu.itemsBySection) return;
            for (const key of Object.keys(menu.itemsBySection)) {
                const arr = Array.isArray(menu.itemsBySection[key]) ? menu.itemsBySection[key] : [];
                for (const it of arr) {
                    if (!it.id) it.id = genId();
                }
            }
        }

        /******************************************************************
         * DEFAULT DATA
         ******************************************************************/
        const DEFAULT_DATA = {
            cover: {
                browserTitle: "Menu della Serata • Casa Edition",
                heroPrefix: "Stasera a casa con Chef Massy:",
                heroGold: "cena da 3 stelle",
                heroDesc: "Un menu completo, elegante e moderno.\nPresentato in modo “wow” come fosse un fine-dining,\nma con il calore di una serata tra amici e famiglia.",
                chefName: "Massimiliano Giannone",
                toast: "“Questa sera ci prendiamo un momento per stare insieme, mangiare bene e fare due risate.\nIo cucino, voi godetevela.”",
                metaOrario: "06/01/2026\nalle ore 20:30",
                metaNote: "Chiedimi per allergeni o alternative.\nPiatti serviti “a ondate”."
            },
            sections: [
                { key: "antipasti", title: "Antipasti", desc: "Il benvenuto (piccoli assaggi, grande impatto)" },
                { key: "primi", title: "Primi", desc: "La portata che fa innamorare" },
                { key: "secondi", title: "Secondi", desc: "Il piatto protagonista" },
                { key: "dolci", title: "Dolci", desc: "Finale morbido, felice, memorabile" },
                { key: "bevande", title: "Bevande", desc: "Durante la serata (scegli, abbina, brinda)" }
            ],
            itemsBySection: {
                antipasti: [
                    { id: genId(), name: "Bruschette gourmet", info: "Croccanti, profumate, con topping ricchi e servite “a degustazione”.", imageUrl: "" },
                    { id: genId(), name: "Spritz", info: "Leggero e frizzante, perfetto per aprire la serata con stile.", imageUrl: "" }
                ],
                primi: [
                    { id: genId(), name: "Pasta con gamberi e stracciatella", info: "Gamberi cotti con vino bianco, bisk di gambero, stracciatella e gambero rosso crudo: cremoso, saporito e fresco.", imageUrl: "" }
                ],
                secondi: [
                    { id: genId(), name: "Pesce spada in crosta di pistacchio", info: "Rosolato con vino bianco e brodo di pesce chiarificato, servito con fondo e crosta di pistacchio: delicato e sorprendente.", imageUrl: "" }
                ],
                dolci: [
                    { id: genId(), name: "Cannolo siciliano", info: "Cremoso e croccante: un classico che chiude la serata con il sapore della nostra terra.", imageUrl: "" }
                ],
                bevande: [
                    { id: genId(), name: "Acqua liscia", info: "Sempre in tavola, servita fresca.", imageUrl: "" },
                    { id: genId(), name: "[Inserisci qui i vini della serata]", info: "Esempio:\nBianco fresco per antipasti\nRosso morbido per i secondi\nBollicine per brindare", imageUrl: "" },
                    { id: genId(), name: "Coca-Cola", info: "Classica e fresca.", imageUrl: "" },
                    { id: genId(), name: "Birre", info: "Birre presenti:\nPeroni\nBirra Messina", imageUrl: "" },
                    { id: genId(), name: "Acqua frizzante", info: "Per chi la preferisce frizzante.", imageUrl: "" }
                ]
            }
        };

        /******************************************************************
         * STORAGE + REMOTE LOADING
         ******************************************************************/
        // ✅ Soluzione A: non esplode più se localStorage è pieno
        function saveMenuToLocal(data) {
            try {
                localStorage.setItem(MENU_KEY, JSON.stringify(data));
                return true;
            } catch (err) {
                console.warn("LocalStorage pieno/non disponibile:", err);
                return false;
            }
        }

        function normalizeMenuData(parsed) {
            if (!parsed || typeof parsed !== "object") return deepClone(DEFAULT_DATA);
            parsed.cover = parsed.cover || {};

            if (!parsed.cover.browserTitle) parsed.cover.browserTitle = DEFAULT_DATA.cover.browserTitle;
            if (!parsed.cover.chefName) parsed.cover.chefName = DEFAULT_DATA.cover.chefName;

            parsed.cover.heroDesc = brToNl(parsed.cover.heroDesc ?? DEFAULT_DATA.cover.heroDesc);
            parsed.cover.toast = brToNl(parsed.cover.toast ?? DEFAULT_DATA.cover.toast);
            parsed.cover.metaOrario = brToNl(parsed.cover.metaOrario ?? DEFAULT_DATA.cover.metaOrario);
            parsed.cover.metaNote = brToNl(parsed.cover.metaNote ?? DEFAULT_DATA.cover.metaNote);

            parsed.sections = Array.isArray(parsed.sections) ? parsed.sections : deepClone(DEFAULT_DATA.sections);
            parsed.itemsBySection = parsed.itemsBySection || deepClone(DEFAULT_DATA.itemsBySection);

            ensureItemIds(parsed);
            return parsed;
        }

        function loadMenuFromLocal() {
            const raw = localStorage.getItem(MENU_KEY);
            if (!raw) saveMenuToLocal(deepClone(DEFAULT_DATA));

            const parsed = safeParseJson(localStorage.getItem(MENU_KEY));
            if (!parsed) {
                saveMenuToLocal(deepClone(DEFAULT_DATA));
                return deepClone(DEFAULT_DATA);
            }
            return normalizeMenuData(parsed);
        }

        async function loadMenuAsync() {
            try {
                const res = await fetch(REMOTE_DATA_FILE, { cache: "no-store" });
                if (res.ok) {
                    const txt = await res.text();
                    const data = JSON.parse(txt);
                    const norm = normalizeMenuData(data);
                    saveMenuToLocal(norm);
                    return norm;
                }
            } catch (e) { }
            return loadMenuFromLocal();
        }

        /******************************************************************
         * SESSION
         ******************************************************************/
        function isAdmin() { return localStorage.getItem(SESSION_KEY) === "1"; }
        function logout() { localStorage.removeItem(SESSION_KEY); }

        /******************************************************************
         * DRAG & DROP (riordino schede)
         ******************************************************************/
        let DRAG = { sec: null, itemId: null, cardEl: null, markerEl: null, lastKey: null };

        function getCardUnderPointer(x, y) {
            const el = document.elementFromPoint(x, y);
            if (!el) return null;
            return el.closest?.(".card") || null;
        }

        function ensureMarker(grid, refHeight = 260) {
            if (DRAG.markerEl && DRAG.markerEl.parentElement === grid) return DRAG.markerEl;

            if (DRAG.markerEl && DRAG.markerEl.parentElement) {
                DRAG.markerEl.parentElement.removeChild(DRAG.markerEl);
            }

            const m = document.createElement("div");
            m.className = "dropMarker";
            m.style.minHeight = refHeight + "px";
            DRAG.markerEl = m;
            grid.appendChild(m);
            return m;
        }

        function removeMarker() {
            if (DRAG.markerEl && DRAG.markerEl.parentElement) {
                DRAG.markerEl.parentElement.removeChild(DRAG.markerEl);
            }
            DRAG.markerEl = null;
            DRAG.lastKey = null;
        }

        function attachDnDHandlers() {
            document.querySelectorAll("[data-drag-handle]").forEach(h => {
                h.setAttribute("draggable", "true");

                h.addEventListener("dragstart", (e) => {
                    const card = h.closest(".card");
                    if (!card) return;

                    const sec = card.getAttribute("data-sec");
                    const id = card.getAttribute("data-id");
                    if (!sec || !id) return;

                    DRAG.sec = sec;
                    DRAG.itemId = id;
                    DRAG.cardEl = card;

                    card.classList.add("dragging");

                    try {
                        e.dataTransfer.effectAllowed = "move";
                        e.dataTransfer.setData("text/plain", `${sec}:${id}`);

                        const ghost = card.cloneNode(true);
                        ghost.style.position = "fixed";
                        ghost.style.top = "-9999px";
                        ghost.style.left = "-9999px";
                        ghost.style.width = card.offsetWidth + "px";
                        document.body.appendChild(ghost);
                        e.dataTransfer.setDragImage(ghost, 20, 20);
                        setTimeout(() => ghost.remove(), 0);
                    } catch (err) { }
                });

                h.addEventListener("dragend", () => {
                    if (DRAG.cardEl) DRAG.cardEl.classList.remove("dragging");
                    removeMarker();
                    DRAG = { sec: null, itemId: null, cardEl: null, markerEl: null, lastKey: null };
                });
            });

            document.querySelectorAll(".grid[data-section]").forEach(grid => {
                grid.addEventListener("dragover", (e) => {
                    if (!DRAG.cardEl) return;

                    const sec = grid.getAttribute("data-section");
                    if (sec !== DRAG.sec) return;

                    e.preventDefault();
                    e.dataTransfer.dropEffect = "move";

                    const under = getCardUnderPointer(e.clientX, e.clientY);
                    const marker = ensureMarker(grid, DRAG.cardEl.offsetHeight || 260);

                    if (!under || !grid.contains(under) || under.classList.contains("dragging")) {
                        const key = "END";
                        if (DRAG.lastKey !== key) {
                            DRAG.lastKey = key;
                            grid.appendChild(marker);
                        }
                        return;
                    }

                    const r = under.getBoundingClientRect();
                    const before = (e.clientY < (r.top + r.height / 2));

                    const key = `${under.getAttribute("data-id") || ""}:${before ? "B" : "A"}`;
                    if (DRAG.lastKey === key) return;
                    DRAG.lastKey = key;

                    if (before) grid.insertBefore(marker, under);
                    else grid.insertBefore(marker, under.nextSibling);
                });

                grid.addEventListener("drop", (e) => {
                    if (!DRAG.cardEl) return;

                    const sec = grid.getAttribute("data-section");
                    if (sec !== DRAG.sec) return;

                    e.preventDefault();

                    if (DRAG.markerEl && DRAG.markerEl.parentElement === grid) {
                        grid.insertBefore(DRAG.cardEl, DRAG.markerEl);
                    }

                    removeMarker();
                    commitOrderFromDom(sec, grid);

                    if (DRAG.cardEl) DRAG.cardEl.classList.remove("dragging");
                    DRAG = { sec: null, itemId: null, cardEl: null, markerEl: null, lastKey: null };
                });
            });
        }

        function commitOrderFromDom(sectionKey, gridEl) {
            ensureDraft();

            const idsInDom = [...gridEl.querySelectorAll(".card")]
                .map(c => c.getAttribute("data-id"))
                .filter(Boolean);

            const current = DRAFT.itemsBySection[sectionKey] || [];
            const map = new Map(current.map(it => [String(it.id), it]));

            const next = [];
            for (const id of idsInDom) {
                const it = map.get(String(id));
                if (it) next.push(it);
            }
            for (const it of current) {
                if (!idsInDom.includes(String(it.id))) next.push(it);
            }

            DRAFT.itemsBySection[sectionKey] = next;
            setDirty(true);

            renderPublic(DRAFT, true);
        }

        /******************************************************************
         * RENDER
         ******************************************************************/
        function renderPublic(menu, adminMode) {
            menu = normalizeMenuData(menu);
            document.title = menu.cover.browserTitle || DEFAULT_DATA.cover.browserTitle;

            $("chefNameTop").textContent = menu.cover.chefName || DEFAULT_DATA.cover.chefName;
            $("heroPrefix").textContent = menu.cover.heroPrefix || "";
            $("heroGold").textContent = menu.cover.heroGold || "";

            $("heroDesc").innerHTML = nlToBr(menu.cover.heroDesc || "");
            $("toastText").innerHTML = nlToBr(menu.cover.toast || "");

            $("metaOrario").innerHTML = nlToBr(menu.cover.metaOrario || "");
            $("metaNote").innerHTML = nlToBr(menu.cover.metaNote || "");

            $("editEventBtn").style.display = adminMode ? "inline-flex" : "none";

            const root = $("menuRoot");
            root.innerHTML = "";

            for (const section of menu.sections) {
                const items = (menu.itemsBySection && menu.itemsBySection[section.key]) ? menu.itemsBySection[section.key] : [];

                const sectionEl = document.createElement("section");
                sectionEl.className = "section";
                sectionEl.setAttribute("aria-label", section.title);

                const actionsHtml = adminMode ? `
                      <div class="sectionActions">
                        <button class="miniBtn" title="Aggiungi" data-add="${escapeXml(section.key)}">+</button>
                      </div>
                    ` : `<div></div>`;

                sectionEl.innerHTML = `
                      <div class="sectionHead">
                        <h2><span class="dot" aria-hidden="true"></span> ${escapeXml(section.title)}</h2>
                        <div style="display:flex; align-items:baseline; gap:12px;">
                          <p class="desc">${escapeXml(section.desc || "")}</p>
                          ${actionsHtml}
                        </div>
                      </div>
                      <div class="grid" data-section="${escapeXml(section.key)}"></div>
                    `;

                const grid = sectionEl.querySelector(".grid");

                items.forEach((it, idx) => {
                    const imgSrc = resolveImageSrc(it.imageUrl, it.name || "Piatto");

                    const card = document.createElement("article");
                    card.className = "card";
                    card.setAttribute("data-idx", String(idx));
                    card.setAttribute("data-sec", section.key);
                    card.setAttribute("data-id", String(it.id || ""));

                    card.innerHTML = `
                        <div class="img">
                          ${adminMode ? `
                            <div class="dragBtnWrap">
                              <button class="dragBtn" title="Trascina per riordinare" data-drag-handle="1">⠿</button>
                            </div>
                            <div class="cardBtnsRight">
                              <button class="editBtn" title="Modifica" data-edit="${escapeXml(section.key)}:${idx}">✏️</button>
                              <button class="delBtn" title="Elimina" data-del="${escapeXml(section.key)}:${idx}">−</button>
                            </div>
                          ` : ``}
                          <img alt="${escapeXml(it.name || "Piatto")}" src="${imgSrc}">
                        </div>
                        <div class="content">
                          <h3 class="name">${escapeXml(it.name || "")}</h3>
                          <p class="info">${escapeXml(it.info || "")}</p>
                        </div>
                      `;
                    grid.appendChild(card);
                });

                root.appendChild(sectionEl);
            }

            document.querySelectorAll('.section .grid').forEach(grid => {
                const count = grid.querySelectorAll('.card').length;
                if (count > 0 && count < 3) {
                    grid.classList.add('center-few');
                    grid.style.setProperty('--cols', String(count));
                } else {
                    grid.classList.remove('center-few');
                    grid.style.removeProperty('--cols');
                }
            });

            if (adminMode) {
                document.querySelectorAll("[data-add]").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const key = btn.getAttribute("data-add");
                        openCreateModal(key);
                    });
                });

                document.querySelectorAll("[data-del]").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const v = btn.getAttribute("data-del");
                        const [sec, idxStr] = v.split(":");
                        deleteItem(sec, Number(idxStr));
                    });
                });

                document.querySelectorAll("[data-edit]").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const v = btn.getAttribute("data-edit");
                        const [sec, idxStr] = v.split(":");
                        openEditModal(sec, Number(idxStr));
                    });
                });

                attachDnDHandlers();
            }
        }

        function ensureDraft() {
            if (!DRAFT) DRAFT = deepClone(MENU);
            DRAFT = normalizeMenuData(DRAFT);
            if (!DRAFT.itemsBySection) DRAFT.itemsBySection = {};
            if (!DRAFT.cover) DRAFT.cover = deepClone(DEFAULT_DATA.cover);
            ensureItemIds(DRAFT);
        }

        function openCreateModal(sectionKey) {
            ensureDraft();
            const empty = { id: genId(), name: "", info: "", imageUrl: "" };
            openItemModal("Aggiungi piatto", empty, (savedItem) => {
                const list = DRAFT.itemsBySection[sectionKey] || (DRAFT.itemsBySection[sectionKey] = []);
                list.push(savedItem);
                setDirty(true);
                renderPublic(DRAFT, true);
            });
        }

        function openEditModal(sectionKey, idx) {
            ensureDraft();
            const list = DRAFT.itemsBySection[sectionKey] || [];
            const it = list[idx];
            if (!it) return;
            openItemModal("Modifica piatto", deepClone(it), (savedItem) => {
                savedItem.id = it.id || savedItem.id || genId();
                list[idx] = savedItem;
                setDirty(true);
                renderPublic(DRAFT, true);
            }, true);
        }

        function deleteItem(sectionKey, idx) {
            ensureDraft();
            const list = DRAFT.itemsBySection[sectionKey] || [];
            const it = list[idx];
            if (!it) return;

            openModal("Elimina", `
                    <div class="panel">
                      <b style="letter-spacing:.18em; text-transform:uppercase; font-size:12px;">Conferma</b>
                      <p class="mini">Vuoi eliminare: <b>${escapeXml(it.name || "(senza nome)")}</b>?</p>
                      <div class="right">
                        <button class="btn" id="cancelDel" type="button">Annulla</button>
                        <button class="btn danger" id="doDel" type="button">Elimina</button>
                      </div>
                    </div>
                  `);

            setTimeout(() => {
                const c = document.getElementById("cancelDel");
                const d = document.getElementById("doDel");
                if (c) c.onclick = closeModal;
                if (d) d.onclick = () => {
                    list.splice(idx, 1);
                    setDirty(true);
                    renderPublic(DRAFT, true);
                    closeModal();
                };
            }, 0);
        }

        /******************************************************************
         * ITEM MODAL (✅ salva solo path immage/filename, NO base64)
         ******************************************************************/
        function openItemModal(title, item, onSave, allowEmptyName = false) {
            const currentImg = (item.imageUrl && String(item.imageUrl).trim()) ? String(item.imageUrl).trim() : "";
            const preview = resolveImageSrc(currentImg, item.name || "Piatto");

            openModal(title, `
                    <div class="panel">
                      <div class="row">
                        <label>Titolo</label>
                        <input id="fName" type="text" value="${escapeXml(item.name || "")}" placeholder="Es: Bruschette gourmet" />
                      </div>

                      <div class="row">
                        <label>Descrizione</label>
                        <textarea id="fInfo" placeholder="Descrizione breve...">${escapeXml(item.info || "")}</textarea>
                      </div>

                      <div class="row">
                        <label>Immagine</label>
                        <div class="fileRow">
                          <div class="thumb"><img id="imgPreview" alt="preview" src="${preview}"></div>

                          <div class="fileActions">
                            <input id="fFile" type="file" accept="image/*" style="display:none" />
                            <button class="btn" id="pickFile" type="button">📷 Seleziona file</button>
                            <button class="btn danger" id="clearImg" type="button">Rimuovi</button>
                          </div>

                          <div class="mini">
                            ✅ Importante: selezionando un file, nel JSON verrà salvato solo il riferimento:
                            <b>${escapeXml(IMAGES_FOLDER)}nomefile.jpg</b><br/>
                            Poi devi copiare quel file dentro la cartella <b>${escapeXml(IMAGES_FOLDER)}</b> del progetto prima di caricare su GitHub.
                          </div>

                          <div class="mini">Oppure incolla un URL (opzionale):</div>
                          <input id="fImgUrl" type="text" value="${escapeXml(currentImg && (currentImg.startsWith("http://") || currentImg.startsWith("https://")) ? currentImg : "")}" placeholder="https://..." />
                        </div>
                      </div>

                      <div class="right">
                        <button class="btn" id="cancelItem" type="button">Annulla</button>
                        <button class="btn ok" id="saveItem" type="button">Conferma</button>
                      </div>
                    </div>
                  `);

            setTimeout(() => {
                const cancel = document.getElementById("cancelItem");
                const save = document.getElementById("saveItem");
                const nameEl = document.getElementById("fName");

                const pickFileBtn = document.getElementById("pickFile");
                const fileInput = document.getElementById("fFile");
                const clearBtn = document.getElementById("clearImg");
                const previewImg = document.getElementById("imgPreview");
                const urlInput = document.getElementById("fImgUrl");

                // ✅ questo è ciò che verrà salvato nel JSON (path relativo o URL)
                let modalImageValue = currentImg;

                // ✅ anteprima locale (blob url) SOLO per vedere la preview adesso
                let localPreviewObjectUrl = "";

                function setPreview(src) {
                    previewImg.src = resolveImageSrc(src, nameEl.value || "Piatto");
                }

                function revokeLocalPreview() {
                    if (localPreviewObjectUrl) {
                        try { URL.revokeObjectURL(localPreviewObjectUrl); } catch { }
                        localPreviewObjectUrl = "";
                    }
                }

                if (cancel) cancel.onclick = () => {
                    revokeLocalPreview();
                    closeModal();
                };

                if (pickFileBtn && fileInput) {
                    pickFileBtn.onclick = () => fileInput.click();

                    fileInput.onchange = () => {
                        const file = fileInput.files && fileInput.files[0];
                        if (!file) return;

                        // ✅ salva solo "immage/nomefile.ext" nel JSON
                        modalImageValue = IMAGES_FOLDER + file.name;

                        // ✅ anteprima immediata dal file scelto (non finisce nel JSON)
                        revokeLocalPreview();
                        localPreviewObjectUrl = URL.createObjectURL(file);
                        previewImg.src = localPreviewObjectUrl;

                        // se stai usando file, svuota URL
                        if (urlInput) urlInput.value = "";
                    };
                }

                if (clearBtn) {
                    clearBtn.onclick = () => {
                        revokeLocalPreview();
                        modalImageValue = "";
                        if (fileInput) fileInput.value = "";
                        if (urlInput) urlInput.value = "";
                        setPreview("");
                    };
                }

                if (urlInput) {
                    urlInput.addEventListener("input", () => {
                        const v = urlInput.value.trim();
                        if (v) {
                            revokeLocalPreview();
                            modalImageValue = v;   // URL vero
                            setPreview(v);
                        } else {
                            // se era un URL, svuota
                            if (modalImageValue && (modalImageValue.startsWith("http://") || modalImageValue.startsWith("https://"))) {
                                modalImageValue = "";
                                setPreview("");
                            }
                        }
                    });
                }

                if (nameEl) {
                    nameEl.addEventListener("input", () => {
                        // se non c'è immagine, rigenera placeholder col titolo
                        if (!modalImageValue) setPreview("");
                    });
                }

                if (save) save.onclick = () => {
                    const name = document.getElementById("fName").value.trim();
                    const info = document.getElementById("fInfo").value;
                    const url = (document.getElementById("fImgUrl").value || "").trim();

                    // se hanno scritto un URL, preferisci quello
                    let finalImg = modalImageValue;
                    if (url) finalImg = url;

                    if (!allowEmptyName && !name) {
                        nameEl.focus();
                        nameEl.style.borderColor = "rgba(255,91,107,.75)";
                        return;
                    }

                    onSave({
                        id: item.id || genId(),
                        name: name || "(senza nome)",
                        info: String(info ?? "").replace(/\r\n/g, "\n"),
                        imageUrl: String(finalImg || "").trim()
                    });

                    revokeLocalPreview();
                    closeModal();
                };
            }, 0);
        }

        function openEventModal() {
            ensureDraft();
            const c = DRAFT.cover;

            openModal("Modifica evento", `
                    <div class="panel">
                      <div class="row">
                        <label>Titolo browser</label>
                        <input id="eBrowserTitle" type="text" value="${escapeXml(c.browserTitle || "")}" />
                      </div>

                      <div class="row">
                        <label>Titolo (prima parte)</label>
                        <input id="eHeroPrefix" type="text" value="${escapeXml(c.heroPrefix || "")}" />
                      </div>

                      <div class="row">
                        <label>Titolo (parte oro)</label>
                        <input id="eHeroGold" type="text" value="${escapeXml(c.heroGold || "")}" />
                      </div>

                      <div class="row">
                        <label>Descrizione evento</label>
                        <textarea id="eHeroDesc">${escapeXml(brToNl(String(c.heroDesc || "")))}</textarea>
                      </div>

                      <div class="row">
                        <label>Dettagli serata</label>
                        <textarea id="eToast">${escapeXml(brToNl(String(c.toast || "")))}</textarea>
                      </div>

                      <div class="row">
                        <label>Data & Orario</label>
                        <textarea id="eOrario">${escapeXml(brToNl(String(c.metaOrario || "")))}</textarea>
                      </div>

                      <div class="row">
                        <label>Note</label>
                        <textarea id="eNote">${escapeXml(brToNl(String(c.metaNote || "")))}</textarea>
                      </div>

                      <div class="right">
                        <button class="btn" id="cancelEvent" type="button">Annulla</button>
                        <button class="btn ok" id="saveEvent" type="button">Conferma</button>
                      </div>
                    </div>
                  `);

            setTimeout(() => {
                const cancel = document.getElementById("cancelEvent");
                const save = document.getElementById("saveEvent");
                if (cancel) cancel.onclick = closeModal;

                if (save) save.onclick = () => {
                    const browserTitle = document.getElementById("eBrowserTitle").value.trim();
                    const heroPrefix = document.getElementById("eHeroPrefix").value.trim();
                    const heroGold = document.getElementById("eHeroGold").value.trim();

                    const heroDesc = document.getElementById("eHeroDesc").value;
                    const toast = document.getElementById("eToast").value;
                    const orario = document.getElementById("eOrario").value;
                    const note = document.getElementById("eNote").value;

                    DRAFT.cover.browserTitle = browserTitle || DEFAULT_DATA.cover.browserTitle;
                    DRAFT.cover.heroPrefix = heroPrefix || "";
                    DRAFT.cover.heroGold = heroGold || "";

                    DRAFT.cover.heroDesc = String(heroDesc ?? "").replace(/\r\n/g, "\n");
                    DRAFT.cover.toast = String(toast ?? "").replace(/\r\n/g, "\n");
                    DRAFT.cover.metaOrario = String(orario ?? "").replace(/\r\n/g, "\n");
                    DRAFT.cover.metaNote = String(note ?? "").replace(/\r\n/g, "\n");

                    setDirty(true);
                    renderPublic(DRAFT, true);
                    closeModal();
                };
            }, 0);
        }

        function showLogin() {
            openModal("Login Admin", `
                    <div class="panel">
                      <div class="row">
                        <label>Username</label>
                        <input id="loginUser" type="text" autocomplete="username" />
                      </div>
                      <div class="row">
                        <label>Password</label>
                        <input id="loginPass" type="password" autocomplete="current-password" />
                      </div>
                      <div class="right">
                        <button class="btn ok" id="doLogin" type="button">Accedi</button>
                      </div>
                    </div>
                  `);

            setTimeout(() => {
                const btn = document.getElementById("doLogin");
                const u = document.getElementById("loginUser");
                const p = document.getElementById("loginPass");

                function attempt() {
                    const uu = (u.value || "").trim();
                    const pp = (p.value || "").trim();
                    if (uu === ADMIN_USERNAME && pp === ADMIN_PASSWORD) {
                        localStorage.setItem(SESSION_KEY, "1");
                        closeModal();
                        enterAdmin();
                    } else {
                        openModal("Login Admin", `
                          <div class="panel">
                            <b style="letter-spacing:.18em; text-transform:uppercase; font-size:12px;">Credenziali errate</b>
                            <p class="mini">Riprova.</p>
                            <div class="right">
                              <button class="btn ok" id="retryLogin" type="button">Riprova</button>
                            </div>
                          </div>
                        `);
                        setTimeout(() => {
                            const r = document.getElementById("retryLogin");
                            if (r) r.onclick = showLogin;
                        }, 0);
                    }
                }

                if (btn) btn.onclick = attempt;
                if (p) p.addEventListener("keydown", (e) => { if (e.key === "Enter") attempt(); });
            }, 0);
        }

        function enterAdmin() {
            document.body.classList.add("admin");
            $("logoutBtn").style.display = "inline-flex";
            $("saveFloat").style.display = "flex";
            $("editEventBtn").style.display = "inline-flex";

            DRAFT = normalizeMenuData(deepClone(MENU || loadMenuFromLocal()));
            setDirty(false);
            renderPublic(DRAFT, true);
        }

        function exitAdmin() {
            document.body.classList.remove("admin");
            $("logoutBtn").style.display = "none";
            $("saveFloat").style.display = "none";
            $("editEventBtn").style.display = "none";
            setDirty(false);
            DRAFT = null;
            renderPublic(MENU, false);
        }

        /* download robusto */
        function downloadJsonFile(data, filename = "menu-data.json") {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.rel = "noopener";
            a.style.display = "none";
            document.body.appendChild(a);

            const ev = new MouseEvent("click", { bubbles: true, cancelable: true, view: window });
            a.dispatchEvent(ev);

            setTimeout(() => {
                try { a.remove(); } catch { }
                try { URL.revokeObjectURL(url); } catch { }
            }, 600);
        }

        // ✅ Salvataggio A: scarica SEMPRE json, poi prova localStorage senza bloccare
        function saveAll() {
            if (!isAdmin() || !DRAFT) return;

            try {
                DRAFT = normalizeMenuData(DRAFT);

                // 1) scarica sempre (persistenza vera)
                downloadJsonFile(DRAFT, "menu-data.json");

                // 2) cache locale (non obbligatoria)
                const okLocal = saveMenuToLocal(DRAFT);

                MENU = deepClone(DRAFT);
                setDirty(false);

                openModal("Salvato", `
                            <div class="panel">
                              <b style="letter-spacing:.18em; text-transform:uppercase; font-size:12px;">Ok ✅</b>
                              <p class="mini">
                                Ho scaricato <b>menu-data.json</b>.<br/>
                                ${okLocal ? `Cache locale aggiornata.` : `<span style="color: rgba(255,91,107,.9);">Cache locale non aggiornata (spazio browser pieno/non disponibile).</span>`}
                                <br/><br/>
                                Ricorda: se hai scelto un file immagine, nel JSON c’è scritto tipo <b>${escapeXml(IMAGES_FOLDER)}nomefile.jpg</b><br/>
                                quindi devi avere davvero quel file dentro la cartella <b>${escapeXml(IMAGES_FOLDER)}</b> su GitHub.
                              </p>
                              <div class="right">
                                <button class="btn ok" id="okClose" type="button">Ok</button>
                              </div>
                            </div>
                        `);

                setTimeout(() => {
                    const b = document.getElementById("okClose");
                    if (b) b.onclick = closeModal;
                }, 0);

                renderPublic(DRAFT, true);
            } catch (err) {
                console.error(err);
                openModal("Errore Salvataggio", `
                            <div class="panel">
                              <b style="letter-spacing:.18em; text-transform:uppercase; font-size:12px; color: rgba(255,91,107,.9);">Errore ❌</b>
                              <p class="mini">
                                Il salvataggio si è interrotto per un errore JavaScript.<br/>
                                Apri la console (F12 → Console) e guarda l’errore stampato.
                              </p>
                              <div class="mini" style="margin-top:10px; padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
                                ${escapeXml(String(err && (err.stack || err.message) ? (err.stack || err.message) : err))}
                              </div>
                              <div class="right">
                                <button class="btn ok" id="errClose" type="button">Ok</button>
                              </div>
                            </div>
                        `);

                setTimeout(() => {
                    const b = document.getElementById("errClose");
                    if (b) b.onclick = closeModal;
                }, 0);
            }
        }

        (async function init() {
            if (location.hash) {
                history.replaceState(null, "", location.pathname + location.search);
            }

            $("toggleTheme").addEventListener("click", () => document.body.classList.toggle("light"));
            $("printBtn").addEventListener("click", () => window.print());
            $("modalClose").addEventListener("click", closeModal);

            $("modalBack").addEventListener("click", (e) => { });

            $("adminBtn").addEventListener("click", () => {
                if (isAdmin()) enterAdmin();
                else showLogin();
            });

            $("logoutBtn").addEventListener("click", () => {
                logout();
                exitAdmin();
            });

            $("saveAllBtn").addEventListener("click", saveAll);

            $("editEventBtn").addEventListener("click", () => {
                if (!isAdmin()) return;
                openEventModal();
            });

            MENU = await loadMenuAsync();
            renderPublic(MENU, false);

            window.addEventListener("beforeunload", (e) => {
                if (isAdmin() && DIRTY) {
                    e.preventDefault();
                    e.returnValue = "";
                }
            });
        })();
    </script>
</body>
</html>