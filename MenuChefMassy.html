<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0b0b0f" />
    <title>Menu della Serata • Casa Edition</title>

    <style>
        :root {
            --bg: #07070a;
            --bg2: #0a0a12;
            --panel: rgba(255,255,255,.06);
            --panel2: rgba(255,255,255,.08);
            --border: rgba(255,255,255,.12);
            --text: rgba(255,255,255,.92);
            --muted: rgba(255,255,255,.66);
            --gold1: #f6d365;
            --gold2: #d6ae54;
            --accent: #caa24a;
            --shadow: 0 24px 80px rgba(0,0,0,.55);
            --radius: 18px;
            --radius2: 26px;
            --max: 1180px;
            --danger: #ff5b6b;
            --ok: #38d6a5;
            /* ✅ NEW: background base (default vs themed) */
            --baseBgDefault: radial-gradient(1200px 600px at 15% -10%, rgba(246,211,101,.20), transparent 60%), radial-gradient(900px 500px at 90% 10%, rgba(202,162,74,.18), transparent 55%), radial-gradient(800px 500px at 50% 110%, rgba(120,90,200,.10), transparent 55%), linear-gradient(180deg, var(--bg) 0%, var(--bg2) 40%, var(--bg) 100%);
            --baseBgThemed: radial-gradient(1200px 700px at 20% 0%, rgba(255,255,255,.06), transparent 60%), radial-gradient(900px 600px at 90% 20%, rgba(255,255,255,.05), transparent 55%), linear-gradient(180deg, #050507 0%, #0a0a12 55%, #050507 100%);
            --baseBg: var(--baseBgDefault);
            /* ✅ NEW: base background actually applied (can be customized from admin) */
            --baseBgApplied: var(--baseBgDefault);
            --baseBgColor: ""; /* e.g. #ff7a00 */
            /* NEW: pattern theme layer (default = none) */
            --themePattern: none; /* set to: url("...") via JS */
            --themePatternSize: 420px; /* set via JS */
            --themePatternOpacity: 1; /* 1 = colori reali, nessuna tinta dal background */ /* puoi aumentare se vuoi il pattern più visibile */
        }

        body.light {
            --bg: #f7f5f0;
            --bg2: #ffffff;
            --panel: rgba(0,0,0,.04);
            --panel2: rgba(0,0,0,.06);
            --border: rgba(0,0,0,.10);
            --text: rgba(0,0,0,.88);
            --muted: rgba(0,0,0,.62);
            --shadow: 0 20px 60px rgba(0,0,0,.12);
            --themePatternOpacity: 1;
            /* ✅ in light mode: themed background anche chiaro (se vuoi) */
            --baseBgThemed: radial-gradient(1200px 700px at 20% 0%, rgba(0,0,0,.04), transparent 60%), radial-gradient(900px 600px at 90% 20%, rgba(0,0,0,.03), transparent 55%), linear-gradient(180deg, #ffffff 0%, #f7f5f0 55%, #ffffff 100%);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            min-height: 100%;
        }

        html {
            /* ✅ sfondo base (può essere custom) */
            background: var(--baseBgApplied, var(--baseBg));
            position: relative;
        }

        body {
            min-height: 100%;
            margin: 0;
            position: relative;
            background: transparent;
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ✅ Pattern layer: fixed, always covers viewport; moves with scroll via CSS var */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            background-image: var(--themePattern);
            background-repeat: repeat;
            background-size: var(--themePatternSize) auto;
            /* ✅ scroll motion (updated via JS) */
            background-position: left calc(var(--themeScrollY, 0px));
            opacity: var(--themePatternOpacity);
            filter: saturate(1.08) contrast(1.02);
        }

        body.modal-open {
                overflow: hidden;
                height: 100%;
            }

        .wrap {
            position: relative;
            z-index: 1;
            max-width: var(--max);
            margin: 0 auto;
            padding: 26px 18px 90px;
        }

        /* Top bar */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, rgb(18,18,26), rgb(10,10,18));
            border-radius: var(--radius2);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 10px;
            z-index: 50;
            flex-wrap: wrap;
        }

        body.light .topbar {
            background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.70));
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            background: radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.35), transparent 60%), linear-gradient(135deg, rgba(246,211,101,.95), rgba(202,162,74,.80));
            box-shadow: 0 12px 30px rgba(202,162,74,.25);
            position: relative;
        }

            .logo:after {
                content: "";
                position: absolute;
                inset: 10px;
                border-radius: 12px;
                border: 1px solid rgba(0,0,0,.22);
                background: rgba(0,0,0,.08);
            }

        .brand h1 {
            font-size: 12px;
            margin: 0;
            letter-spacing: .28em;
            text-transform: uppercase;
            color: rgba(255,255,255,.88);
        }

        body.light .brand h1 {
            color: rgba(0,0,0,.78);
        }

        .brand .sub {
            font-size: 12px;
            margin-top: 2px;
            color: var(--muted);
            letter-spacing: .02em;
        }

        /* roles (2 colonne) */
        .roles {
            margin-left: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 6px 10px;
            border-radius: 14px;
            border: 1px solid rgba(246,211,101,.22);
            background: rgba(202,162,74,.10);
            backdrop-filter: blur(8px);
            min-width: 360px;
        }

        .roleCard {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.10);
            background: rgb(10,10,18);
        }

        .roleLabel {
            font-size: 10px;
            letter-spacing: .26em;
            text-transform: uppercase;
            color: rgba(255,255,255,.72);
        }

        .roleName {
            font-size: 12px;
            letter-spacing: .06em;
            color: rgba(255,255,255,.92);
            font-weight: 600;
        }

        body.light .roles {
            background: rgba(0,0,0,.03);
            border-color: rgba(0,0,0,.10);
        }

        body.light .roleCard {
            background: rgba(255,255,255,.65);
            border-color: rgba(0,0,0,.08);
        }

        body.light .roleLabel {
            color: rgba(0,0,0,.60);
        }

        body.light .roleName {
            color: rgba(0,0,0,.80);
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }

        .btn {
            border: 1px solid var(--border);
            background: rgb(14,14,20);
            color: rgba(255,255,255,.84);
            padding: 10px 12px;
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
            transition: transform .12s ease, background .12s ease, border-color .12s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            white-space: nowrap;
        }

        body.light .btn {
            background: rgba(0,0,0,.03);
            color: rgba(0,0,0,.78);
        }

        .btn:hover {
            transform: translateY(-1px);
            background: rgba(255,255,255,.07);
            border-color: rgba(246,211,101,.35);
        }

        body.light .btn:hover {
            background: rgba(0,0,0,.05);
        }

        .btn.danger {
            border-color: rgba(255,91,107,.35);
        }

            .btn.danger:hover {
                border-color: rgba(255,91,107,.55);
            }

        .btn.ok {
            border-color: rgba(56,214,165,.35);
        }

            .btn.ok:hover {
                border-color: rgba(56,214,165,.55);
            }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: linear-gradient(180deg, var(--gold1), var(--gold2));
            box-shadow: 0 0 0 4px rgba(202,162,74,.12);
        }

        .ico {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: -3px;
        }

        @media (max-width: 720px) {
            .roles {
                order: 3;
                width: 100%;
                margin-left: 0;
                min-width: unset;
                grid-template-columns: 1fr;
            }

            .actions {
                order: 4;
                width: 100%;
                justify-content: flex-start;
            }
        }

        /* Cover */
        .cover {
            margin-top: 18px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, rgb(18,18,26), rgb(10,10,18));
            border-radius: var(--radius2);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
        }

        body.light .cover {
            background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.76));
        }

        .cover:before {
            content: "";
            position: absolute;
            inset: -2px;
            background: radial-gradient(620px 200px at 18% 0%, rgba(246,211,101,.18), transparent 60%), radial-gradient(620px 200px at 82% 0%, rgba(202,162,74,.14), transparent 60%);
            pointer-events: none;
        }

        .coverInner {
            position: relative;
            padding: 20px;
            display: grid;
            grid-template-columns: 1.2fr .8fr;
            gap: 16px;
            align-items: stretch;
        }

        @media (max-width: 960px) {
            .coverInner {
                grid-template-columns: 1fr;
            }
        }

        .headline {
            margin: 0;
            font-size: clamp(28px, 3.4vw, 46px);
            line-height: 1.06;
            letter-spacing: -0.02em;
        }

            .headline .gold {
                background: linear-gradient(135deg, var(--gold1), var(--gold2));
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
                text-shadow: 0 18px 60px rgba(202,162,74,.12);
            }

        .lede {
            margin: 10px 0 0;
            color: var(--muted);
            font-size: 14px;
            line-height: 1.6;
            max-width: 72ch;
            white-space: normal;
        }

        .metaGrid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 14px;
        }

        @media (max-width: 520px) {
            .metaGrid {
                grid-template-columns: 1fr;
            }
        }

        .metaCard {
            border: 1px solid rgba(255,255,255,.12);
            background: rgb(10,10,18);
            border-radius: 16px;
            padding: 12px;
        }

        body.light .metaCard {
            border-color: rgba(0,0,0,.10);
            background: rgba(0,0,0,.03);
        }

        .metaCard b {
            display: block;
            font-size: 12px;
            letter-spacing: .18em;
            text-transform: uppercase;
            opacity: .9;
        }

        .metaCard span {
            display: block;
            margin-top: 6px;
            color: var(--muted);
            font-size: 12px;
            line-height: 1.45;
        }

        .toastNote {
            border: 1px solid rgba(246,211,101,.22);
            background: rgba(202,162,74,.10);
            border-radius: 18px;
            padding: 14px;
            height: 100%;
        }

            .toastNote h3 {
                margin: 0;
                font-size: 13px;
                letter-spacing: .22em;
                text-transform: uppercase;
            }

            .toastNote p {
                margin: 10px 0 0;
                color: var(--muted);
                font-size: 13px;
                line-height: 1.6;
                white-space: normal;
            }

        body.light .toastNote p {
            color: rgba(0,0,0,.62);
        }

        /* Sections */
        .section {
            margin-top: 18px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, rgb(18,18,26), rgb(10,10,18));
            border-radius: var(--radius2);
            overflow: hidden;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            position: relative;
        }

        body.light .section {
            background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
        }

        .sectionHead {
            padding: 16px 18px;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,.10);
            background: rgb(12,12,18);
        }

        body.light .sectionHead {
            border-bottom-color: rgba(0,0,0,.08);
            background: rgba(0,0,0,.02);
        }

        .sectionHead h2 {
            margin: 0;
            font-size: 13px;
            letter-spacing: .26em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sectionHead .desc {
            margin: 0;
            color: var(--muted);
            font-size: 12px;
        }

        .sectionActions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .miniBtn {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: 1px solid rgba(246,211,101,.22);
            background: rgba(202,162,74,.10);
            color: rgba(255,255,255,.92);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform .12s ease, border-color .12s ease, background .12s ease;
            user-select: none;
            font-size: 18px;
            line-height: 1;
        }

            .miniBtn:hover {
                transform: translateY(-1px);
                border-color: rgba(246,211,101,.35);
                background: rgba(202,162,74,.16);
            }

        body.light .miniBtn {
            background: rgba(0,0,0,.03);
            border-color: rgba(0,0,0,.10);
            color: rgba(0,0,0,.78);
        }

            body.light .miniBtn:hover {
                background: rgba(0,0,0,.05);
                border-color: rgba(0,0,0,.16);
            }

        .grid {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 14px;
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 560px) {
            /* ✅ TELEFONO: rendi tutto più compatto e metti 2 card per riga */
            .wrap { padding: 18px 12px 84px; }

            .grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 12px;
            }

            .card { grid-column: span 1; }

            .img { height: 15px; }

            .content { padding: 10px 10px 12px; }

            .sectionHead { padding: 12px 14px; }

            .sectionHead h2 { font-size: 13px; }

            /* ✅ TELEFONO: se ci sono le foto laterali, le tengo ai bordi (non nella riga sopra) */
            .sidePortraitMobileRow { display: none !important; }

            body.hasSidePortraits .wrap {
                padding-left: 130px;
                padding-right: 130px;
            }

            body.hasSidePortraits .sidePortrait {
                position: fixed !important;
                top: 120px !important;
                transform: none !important;
                width: 112px !important;
                height: calc(100vh - 160px) !important;
                border-radius: 22px !important;
                z-index: 2 !important;
                pointer-events: none;
                display: block; /* visibilità gestita dal JS (se c'è src valida) */
            }

            body.hasSidePortraits .sideLeft { left: 8px !important; }
            body.hasSidePortraits .sideRight { right: 8px !important; }

            /* ✅ MOBILE PATTERN TUNING: pattern più piccolo e ancorato all'inizio schermo */
            :root { --themePatternSize: 220px; }
            body::before { background-position: left top !important; }

        }

  .card {
            grid-column: span 4;
            border: 1px solid rgba(255,255,255,.10);
            background: rgb(10,10,18);
            border-radius: var(--radius);
            overflow: hidden;
            transition: transform .12s ease, border-color .12s ease, background .12s ease;
            position: relative;
        }

        body.light .card {
            border-color: rgba(0,0,0,.10);
            background: rgba(0,0,0,.02);
        }

        @media (max-width: 980px) {
            .card {
                grid-column: span 6;
            }
        }

        @media (max-width: 560px) {
            .card {
                grid-column: span 1;
            }
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(246,211,101,.28);
            background: rgba(255,255,255,.055);
        }

        body.light .card:hover {
            background: rgba(0,0,0,.04);
        }

        .img {
            height: 230px;
            background: rgba(0,0,0,.20);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.light .img {
            background: rgba(0,0,0,.04);
        }

        .img img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
            display: block;
            filter: contrast(1.04) saturate(1.05);
        }

        .cardBtnsRight {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
            gap: 8px;
            z-index: 3;
        }

        body.admin .cardBtnsRight {
            display: flex;
        }

        .dragBtnWrap {
            position: absolute;
            top: 10px;
            left: 10px;
            display: none;
            z-index: 3;
        }

        body.admin .dragBtnWrap {
            display: block;
        }

        .editBtn, .delBtn, .dragBtn {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: transform .12s ease, border-color .12s ease, background .12s ease;
            font-size: 16px;
            line-height: 1;
            color: rgba(255,255,255,.92);
            border: 1px solid rgba(246,211,101,.28);
            background: rgba(202,162,74,.14);
            backdrop-filter: blur(6px);
        }

        .dragBtn {
            font-size: 18px;
            cursor: grab;
        }

            .dragBtn:active {
                cursor: grabbing;
            }

            .editBtn:hover, .dragBtn:hover {
                transform: translateY(-1px);
                border-color: rgba(246,211,101,.45);
                background: rgba(202,162,74,.20);
            }

        .delBtn {
            border: 1px solid rgba(255,91,107,.35);
            background: rgba(255,91,107,.14);
            font-size: 18px;
        }

            .delBtn:hover {
                transform: translateY(-1px);
                border-color: rgba(255,91,107,.55);
                background: rgba(255,91,107,.20);
            }

        body.light .editBtn, body.light .dragBtn {
            color: rgba(0,0,0,.85);
            background: rgba(0,0,0,.03);
            border-color: rgba(0,0,0,.10);
        }

        body.light .delBtn {
            color: rgba(0,0,0,.85);
        }

        .card.dragging {
            opacity: 0;
        }

        .dragGhost {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            transform: translate3d(0,0,0);
            filter: drop-shadow(0 18px 50px rgba(0,0,0,.55));
            opacity: .92;
        }

        .card.drop-before::before,
        .card.drop-after::after {
            content: "";
            position: absolute;
            left: 10px;
            right: 10px;
            height: 4px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(246,211,101,.2), rgba(246,211,101,.95), rgba(246,211,101,.2));
            box-shadow: 0 0 0 4px rgba(202,162,74,.14), 0 12px 34px rgba(202,162,74,.25);
            pointer-events: none;
        }

        .card.drop-before::before {
            top: 8px;
        }

        .card.drop-after::after {
            bottom: 8px;
        }

        .content {
            padding: 14px 14px 16px;
        }

        .name {
            margin: 0;
            font-size: 15px;
            letter-spacing: -0.01em;
        }

        .info {
            margin: 8px 0 0;
            color: rgba(255,255,255,.72);
            font-size: 12px;
            line-height: 1.55;
            white-space: pre-wrap;
            overflow-wrap: anywhere;
        }

        body.light .info {
            color: rgba(0,0,0,.62);
        }

        .grid.center-few {
            grid-template-columns: repeat(var(--cols, 1), minmax(280px, 360px));
            justify-content: center;
            justify-items: stretch;
        }

            .grid.center-few .card {
                grid-column: auto;
                max-width: 360px;
                width: 100%;
            }

        @media (max-width: 980px) {
            .grid.center-few {
                grid-template-columns: 1fr;
                justify-content: stretch;
            }

                .grid.center-few .card {
                    max-width: none;
                }
        }

        /* Floating save (admin) */
        .saveFloat {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 200;
            display: none;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        body.admin .saveFloat {
            display: flex;
        }

        .pill {
            border: 1px solid rgba(255,255,255,.12);
            background: rgb(12,12,18);
            backdrop-filter: blur(10px);
            color: rgba(255,255,255,.82);
            border-radius: 999px;
            padding: 10px 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.light .pill {
            background: rgba(255,255,255,.8);
            color: rgba(0,0,0,.75);
            border-color: rgba(0,0,0,.10);
        }

        /* Modal */
        .modalBack {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.62);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 999;
        }

            .modalBack.show {
                display: flex;
            }

        .modal {
            width: min(860px, 100%);
            border: 1px solid rgba(255,255,255,.14);
            background: linear-gradient(180deg, rgb(20,20,30), rgb(10,10,16));
            border-radius: 22px;
            box-shadow: 0 40px 120px rgba(0,0,0,.65);
            overflow: hidden;
            backdrop-filter: blur(10px);
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        body.light .modal {
            background: rgba(255,255,255,.95);
            border-color: rgba(0,0,0,.12);
        }

        .modalHead {
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,.10);
            background: rgb(12,12,18);
            flex: 0 0 auto;
        }

        body.light .modalHead {
            border-bottom-color: rgba(0,0,0,.08);
            background: rgba(0,0,0,.02);
        }

        .modalHead h3 {
            margin: 0;
            font-size: 13px;
            letter-spacing: .22em;
            text-transform: uppercase;
        }

        .modalBody {
            padding: 16px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1 1 auto;
            max-height: calc(100vh - 40px - 60px);
        }

        .panel {
            border: 1px solid rgba(255,255,255,.10);
            background: rgb(10,10,18);
            border-radius: 18px;
            padding: 14px;
        }

        body.light .panel {
            border-color: rgba(0,0,0,.10);
            background: rgba(0,0,0,.02);
        }

        .row {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        @media (max-width: 720px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        label {
            font-size: 12px;
            letter-spacing: .18em;
            text-transform: uppercase;
            color: rgba(255,255,255,.80);
        }

        body.light label {
            color: rgba(0,0,0,.70);
        }

        input[type="text"], input[type="password"], textarea, select, input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.18);
            color: var(--text);
            outline: none;
        }

        body.light input[type="text"], body.light input[type="password"], body.light textarea, body.light select, body.light input[type="number"] {
            background: rgba(255,255,255,.75);
            color: rgba(0,0,0,.85);
            border-color: rgba(0,0,0,.10);
        }

        textarea {
            min-height: 90px;
            resize: vertical;
            white-space: pre-wrap;
        }

        .mini {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.5;
            margin-top: 10px;
        }

        .right {
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .fileRow {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .fileActions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .thumb {
            width: 100%;
            height: 160px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.16);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

        body.light .thumb {
            background: rgba(0,0,0,.02);
            border-color: rgba(0,0,0,.10);
        }

        /* Side portraits (500px) */
        .sidePortrait {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 500px; /* ✅ 500 */
            height: 1000px; /* ✅ 500 */
            border-radius: 0px;
            overflow: hidden;
            border: 0px solid rgba(255,255,255,.14);
            background: rgba(0,0,0,.0);
            box-shadow: var(--shadow);
            backdrop-filter: blur(0px);
            z-index: 0;
            display: none;
        }

            .sidePortrait img {
                width: 100%;
                height: 100%;
                object-fit: contain; /* ← NON taglia */
                object-position: center; /* ← CENTRATA */
                display: block;
                background: transparent; /* ← niente riempimento finto */
            }

        .sideLeft {
            left: 14px;
        }

        .sideRight {
            right: 14px;
        }

        body.light .sidePortrait {
            background: rgba(255,255,255,.75);
            border-color: rgba(0,0,0,.12);
        }

        /* su schermi più piccoli, riduco un po' */
        @media (max-width: 1600px) {
            .sidePortrait {
                width: 420px;
                height: 420px;
            }
        }

        @media (max-width: 1240px) {
            .sidePortrait {
                width: 340px;
                height: 340px;
            }
        }

        @media (max-width: 1040px) {
            .sidePortrait {
                width: 280px;
                height: 280px;
            }
        }

        @media (max-width: 980px) {
            /* ✅ MOBILE: non nascondo le foto laterali, le sposto in alto (via JS) e le rendo "card" responsive */
            .sidePortrait {
                position: relative;
                top: auto;
                left: auto;
                right: auto;
                transform: none;
                width: min(44vw, 220px);
                height: auto;
                aspect-ratio: 3 / 4;
                border-radius: 26px;
                z-index: 5;
                display: none; /* verrà mostrata solo se c'è una foto e solo dopo che il JS le ha riposizionate */
                margin: 10px 0;
            }

            .sidePortrait img {
                object-fit: cover;
            }

            /* contenitore mobile creato via JS */
            .sidePortraitMobileRow {
                display: flex;
                gap: 12px;
                justify-content: center;
                align-items: stretch;
                flex-wrap: nowrap;
                margin-top: 12px;
            }

            /* ✅ MOBILE: lo sfondo tema lo gestisco direttamente sul body per evitare lag/bug di iOS con ::before fixed */
            body::before { display: none !important; }

            body {
                background-image: var(--themePattern);
                background-repeat: repeat;
                background-size: var(--themePatternSize) auto;
                background-attachment: scroll;
                background-position: 0 0;
            }
        }

        @media print {
            .topbar, .actions, .saveFloat, .sidePortrait {
                display: none !important;
            }

            body {
                background: white !important;
            }

                body::before {
                    display: none !important;
                }

            .wrap {
                padding: 0;
            }

            .section, .cover {
                box-shadow: none !important;
            }

            .modalBack {
                display: none !important;
            }

            .cardBtnsRight, .dragBtnWrap {
                display: none !important;
            }
        }
    
/* =========================
   EXTRA MOBILE COMPACT (v4)
   - lascia spazio alle foto laterali
   - card piccole (3-4 per riga)
   ========================= */
@media (max-width: 560px) {
  /* contenuto più stretto e leggibile */
  .wrap { padding: 14px 10px 78px; }

  /* topbar e hero più compatti */
  .topbar { padding: 10px 10px; border-radius: 22px; }
  .brand { gap: 10px; }
  .logo { width: 36px; height: 36px; }
  .actions { gap: 8px; }
  .pill, .chip, .miniBtn { padding: 8px 10px; border-radius: 999px; font-size: 12px; }
  .headline { font-size: 26px; line-height: 1.06; }
  .subheadline { font-size: 13px; }

  /* sezioni */
  .section { margin-top: 12px; border-radius: 22px; }
  .sectionHead { padding: 10px 12px; }
  .sectionHead h2 { font-size: 12px; letter-spacing: .18em; }
  .sectionHead .hint { font-size: 11px; }

  /* griglia piatti: più piccola */
  .grid { gap: 8px; padding: 10px; grid-template-columns: repeat(3, 1fr); }
  .card { border-radius: 18px; }
  .img { height: 92px; }
  .content { padding: 8px 8px 10px; }
  .title { font-size: 12px; }
  .desc { font-size: 10px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  /* icone edit/delete più compatte */
  .cardTools { top: 8px; right: 8px; gap: 6px; }
  .miniIcon { width: 26px; height: 26px; }

  /* ====== FOTO LATERALI SU MOBILE ====== */
  body.hasSidePortraits .wrap {
    padding-left: 64px !important;
    padding-right: 64px !important;
  }
  body.hasSidePortraits .sidePortrait {
    top: 82px !important;
    width: 54px !important;
    height: calc(100vh - 118px) !important;
    border-radius: 18px !important;
    opacity: .95 !important;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }
  body.hasSidePortraits .sideLeft { left: 6px !important; }
  body.hasSidePortraits .sideRight { right: 6px !important; }
}

/* schermi davvero stretti (iPhone SE ecc.) */
@media (max-width: 380px) {
  .grid { grid-template-columns: repeat(2, 1fr); }
  body.hasSidePortraits .wrap { padding-left: 58px !important; padding-right: 58px !important; }
  body.hasSidePortraits .sidePortrait { width: 48px !important; }
  .headline { font-size: 24px; }
}



/* =========================
   MOBILE iPhone OPTIM (v5)
   Obiettivo: come screenshot (ritratti ai lati + contenuto centrale stretto),
   con 3 card per riga su iPhone 11 Pro Max (414px).
   ========================= */
@media (max-width: 600px) {
  /* spazio reale per le due immagini laterali */
  body.hasSidePortraits .wrap{
    padding-left: 78px !important;
    padding-right: 78px !important;
  }

  /* ritratti laterali: strisce strette e alte */
  body.hasSidePortraits .sidePortrait{
    top: 88px !important;
    width: 70px !important;
    height: calc(100vh - 120px) !important;
    border-radius: 18px !important;
    opacity: .96 !important;
  }
  body.hasSidePortraits .sideLeft{ left: 6px !important; }
  body.hasSidePortraits .sideRight{ right: 6px !important; }

  /* layout più "denso" */
  .section{ margin-top: 10px; }
  .coverInner{ padding: 14px !important; }
  .lede{ font-size: 13px; }

  /* piatti: 3 per riga su iPhone grandi */
  .grid{
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 8px !important;
    padding: 10px !important;
  }

  .card{ border-radius: 16px !important; }
  .img{ height: 84px !important; }
  .content{ padding: 8px 8px 10px !important; }
  .name{ font-size: 11px !important; }
  .info{
    font-size: 9.5px !important;
    line-height: 1.25 !important;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
}

/* schermi davvero stretti (SE / vecchi Android): 2 per riga */
@media (max-width: 380px) {
  .grid{ grid-template-columns: repeat(2, 1fr) !important; }
  body.hasSidePortraits .wrap{
    padding-left: 70px !important;
    padding-right: 70px !important;
  }
  body.hasSidePortraits .sidePortrait{ width: 62px !important; }
}



/* =========================
   iPHONE FIX LATERALI (v6)
   - ritratti PIÙ LARGHI e NON TAGLIATI
   - contenuto centrale più stretto
   ========================= */
@media (max-width: 560px) {
  /* più spazio alle immagini laterali */
  body.hasSidePortraits .wrap{
    padding-left: 148px !important;
    padding-right: 148px !important;
  }

  /* ritratti laterali più larghi */
  body.hasSidePortraits .sidePortrait{
    width: 132px !important;
    height: calc(100vh - 120px) !important;
    top: 88px !important;
    border-radius: 22px !important;
  }
  body.hasSidePortraits .sideLeft{ left: 6px !important; }
  body.hasSidePortraits .sideRight{ right: 6px !important; }

  /* IMPORTANTISSIMO: non tagliare le persone */
  body.hasSidePortraits .sidePortrait img{
    object-fit: contain !important;
    object-position: center bottom !important;
    background: rgba(0,0,0,.10);
  }

  /* centro ancora più compatto */
  .topbar{ padding: 9px 9px !important; }
  .roles{ padding: 6px 8px !important; }
  .roleLabel{ font-size: 9px !important; }
  .roleName{ font-size: 11px !important; }
  .btn{ padding: 9px 10px !important; font-size: 12px !important; }
  .coverInner{ padding: 12px !important; }
}

/* schermi più piccoli (SE): mantieni laterali grandi ma non soffocare il centro */
@media (max-width: 390px) {
  body.hasSidePortraits .wrap{
    padding-left: 132px !important;
    padding-right: 132px !important;
  }
  body.hasSidePortraits .sidePortrait{
    width: 118px !important;
  }
}



/* =========================
   iPhone / Mobile fine-tune (più cornice, tutto centrato)
   ========================= */
@media (max-width: 430px) {

  /* laterali: più larghe e davvero centrate nello schermo */ /*Questo modifica la larghezza delle foto destra e sinistra*/
  body.hasSidePortraits .sidePortrait{
    width: 80px !important;
    min-width: 80px !important;
    max-width: 80px !important;

    height: 10vh !important;           /* meno “barra lunga” */
    max-height: 10vh !important;

    top: 50% !important;
    transform: translateY(-50%) !important;

    border-radius: 22px !important;
  }

  body.hasSidePortraits .sideLeft{ left: 10px !important; top: 50% !important; transform: translateY(-50%) !important; }
  body.hasSidePortraits .sideRight{ right: 10px !important; top: 50% !important; transform: translateY(-50%) !important; }

  /* IMPORTANTISSIMO: non tagliare e non mettere in basso */
  body.hasSidePortraits .sidePortrait img{
    object-fit: contain !important;
    object-position: center center !important;
    height: 100% !important;
    width: 100% !important;
  }

  /* centro più stretto per dare spazio alle laterali */
  body.hasSidePortraits .page,
  body.hasSidePortraits .container,
  body.hasSidePortraits .wrap,
  body.hasSidePortraits .main,
  body.hasSidePortraits .mainContent{
    padding-left: 70px !important;   /* 160 + margine */
    padding-right: 70px !important;
  }

  /* se esiste un contenitore principale con max-width, lo forzo */
  body.hasSidePortraits .page,
  body.hasSidePortraits .container,
  body.hasSidePortraits .wrap{
    max-width: 100vw !important;
  }
}


/* =========================
   OVERRIDE SIDE PORTRAITS (MOBILE FIRST) - vFinal
   Obiettivi:
   1) Se NON c’è foto => NON mostrare nulla (niente “foto sinistra/destra”)
   2) Se ci sono foto => stanno a filo bordo schermo (left=0 / right=0)
   3) Il contenuto centrale arriva fino a “toccare” le foto (padding = larghezza foto + gap)
   ========================= */

/* Variabili (puoi regolarle qui) */
:root{
  --sideW: 110px;     /* larghezza striscia foto su iPhone 11 Pro Max */
  --sideGap: 10px;    /* spazio tra foto e contenuto centrale */
  --sideTop: 50%;     /* centratura verticale */
}

/* Base: i ritratti NON devono mai mostrare placeholder/alt text */
.sidePortrait img{ display:block; }
.sidePortrait[data-empty="1"]{ display:none !important; } /* JS marca vuoto */

/* MOBILE: foto ai bordi + contenuto “a contatto” */
@media (max-width: 560px){
  body.hasSidePortraits .wrap{
    max-width: 100vw !important;
    padding-left: calc(var(--sideW) + var(--sideGap)) !important;
    padding-right: calc(var(--sideW) + var(--sideGap)) !important;
  }

  body.hasSidePortraits .sidePortrait{
    position: fixed !important;
    top: var(--sideTop) !important;
    transform: translateY(-50%) !important;

    width: var(--sideW) !important;
    height: calc(100vh - 4px) !important;  /* quasi tutta altezza */
    max-height: calc(100vh - 24px) !important;

    border-radius: 22px !important;

    /* a filo bordo */
    left: auto !important;
    right: auto !important;
    margin: 0 !important;
  }

  body.hasSidePortraits .sideLeft{ left: -200 !important; }
  body.hasSidePortraits .sideRight{ right: -200 !important; }

  /* non tagliare le persone */
  body.hasSidePortraits .sidePortrait img{
    width: 100% !important;
    height: 100% !important;
    object-fit: contain !important;
    object-position: center bottom !important;
    background: rgba(0,0,0,.10);
  }
}

/* Schermi molto stretti: riduci leggermente la larghezza per non strozzare il centro */
@media (max-width: 390px){
  :root{ --sideW: 96px; --sideGap: 8px; }
}



/* =========================
   MOBILE SIDE PORTRAITS (v3)
   - immagini ai bordi schermo (sinistra/destra)
   - centrate verticalmente
   - più piccole
   - NESSUN blur / cornici / sfondi
   - contenuto centrale più largo (tocca quasi le foto)
   ========================= */
@media (max-width: 560px) {
  :root{ --sideW: 96px; --sideGap: 6px; }

        body.hasSidePortraits .wrap {
            padding-left: 60px !important;
            padding-right: 60px !important;
        }

  body.hasSidePortraits .sidePortrait{
    position: fixed !important;
    top: 50% !important;
    transform: translateY(-50%) !important;

    width: var(--sideW) !important;
    height: min(78vh, 620px) !important;

    border-radius: 18px !important;
    overflow: visible !important;

    border: 0 !important;
    background: transparent !important;
    box-shadow: none !important;

    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    filter: none !important;
    pointer-events: none !important;
  }

  body.hasSidePortraits .sideLeft{ left: 0 !important; }
  body.hasSidePortraits .sideRight{ right: 0 !important; }

  body.hasSidePortraits .sidePortrait img{
    width: 100% !important;
    height: 100% !important;
    object-fit: contain !important;
    object-position: center !important;
    background: transparent !important;
    filter: none !important;
  }
}

/* telefoni molto stretti: riduci leggermente le foto laterali */
@media (max-width: 390px) {
  :root{ --sideW: 84px; }
}


/* non mostrare testo alt quando non c'è src */
.sidePortrait img:not([src]),
.sidePortrait img[src=""]{ display:none !important; }

</style>
</head>

<body>
    <div class="wrap">
        <header class="topbar">
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div>
                    <h1>Menu della Serata</h1>
                    <div class="sub"><span style="letter-spacing:.08em;">Casa Edition</span></div>
                </div>
            </div>

            <div class="roles" aria-label="Ruoli serata">
                <div class="roleCard">
                    <span class="roleLabel" id="role1Label">Chef della serata</span>
                    <span class="roleName" id="role1Name">Massimiliano Giannone</span>
                </div>
                <div class="roleCard">
                    <span class="roleLabel" id="role2Label">Animazione della serata</span>
                    <span class="roleName" id="role2Name">Anna Maria</span>
                </div>
            </div>

            <div class="actions">
                <button class="btn" id="toggleTheme" type="button" title="Modalità chiara/scura">
                    <span class="dot" aria-hidden="true"></span>
                    Modalità
                </button>

                <button class="btn" id="printBtn" type="button" title="Stampa o salva in PDF">
                    <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M7 8V4h10v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                        <path d="M7 17h10v3H7v-3Z" stroke="currentColor" stroke-width="1.8" />
                        <path d="M6 10h12a2 2 0 0 1 2 2v3h-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                        <path d="M7 15H4v-3a2 2 0 0 1 2-2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                    </svg>
                    PDF / Stampa
                </button>

                <button class="btn" id="editEventBtn" type="button" title="Modifica evento (solo admin)" style="display:none;">
                    ✏️ Modifica evento
                </button>

                <button class="btn" id="adminBtn" type="button" title="Apri modalità admin">
                    <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 3l7 4v6c0 5-3 8-7 8s-7-3-7-8V7l7-4Z" stroke="currentColor" stroke-width="1.8" />
                        <path d="M12 10v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                        <path d="M12 16h.01" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" />
                    </svg>
                    Admin
                </button>

                <button class="btn danger" id="logoutBtn" type="button" title="Logout (solo admin)" style="display:none;">
                    Logout
                </button>
            </div>
        </header>

        <section class="cover" aria-label="Copertina evento">
            <div class="coverInner">
                <div>
                    <h2 class="headline">
                        <span id="heroPrefix">Stasera a casa con Chef Massy:</span>
                        <span class="gold" id="heroGold">cena da 3 stelle</span>
                    </h2>

                    <p class="lede" id="heroDesc">
                        Un menu completo, elegante e moderno.
                    </p>

                    <div class="metaGrid" aria-label="Dettagli serata">
                        <div class="metaCard">
                            <b>Data & Orario</b>
                            <span id="metaOrario">06/01/2026<br />alle ore 20:30</span>
                        </div>
                        <div class="metaCard">
                            <b>Note</b>
                            <span id="metaNote">Chiedimi per allergeni o alternative.</span>
                        </div>
                    </div>
                </div>

                <aside class="toastNote" aria-label="Dettagli serata">
                    <h3>Dettagli serata</h3>
                    <p id="toastText">—</p>
                </aside>
            </div>
        </section>

        <div id="menuRoot"></div>
    </div>

    <!-- Side portraits -->
    <div class="sidePortrait sideLeft" id="sideLeft" aria-hidden="true">
        <img id="sideLeftImg" alt="Foto sinistra" />
    </div>
    <div class="sidePortrait sideRight" id="sideRight" aria-hidden="true">
        <img id="sideRightImg" alt="Foto destra" />
    </div>

    <div class="saveFloat" id="saveFloat">
        <div class="pill" id="dirtyPill" style="display:none;">
            <span class="dot" aria-hidden="true"></span>
            Modifiche non salvate
        </div>
        <button class="btn ok" id="saveAllBtn" type="button" title="Salva + scarica menu-data.json">Salva</button>
    </div>

    <div class="modalBack" id="modalBack" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modalHead">
                <h3 id="modalTitle">—</h3>
                <button class="btn danger" id="modalClose" type="button">Chiudi</button>
            </div>
            <div class="modalBody" id="modalBody"></div>
        </div>
    </div>

    <script>
        /******************************************************************
         * CONFIG
        /******************************************************************
         * SIDE PORTRAITS
         ******************************************************************/
        const ADMIN_USERNAME = "admin";
        const ADMIN_PASSWORD = "1234";

        const REMOTE_DATA_FILE = "menu-data.json";

        const SESSION_KEY = "menu_admin_session_v13";
        const MENU_KEY = "menu_data_v13_localcache";

        // cartella immagini
        const IMAGES_FOLDER = "immage/";

        let MENU = null;
        let DRAFT = null;
        let DIRTY = false;

        function $(id) { return document.getElementById(id); }

        function escapeXml(s) {
            return String(s ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        function safeParseJson(txt) { try { return JSON.parse(txt); } catch { return null; } }
        function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

        function setDirty(v) {
            DIRTY = v;
            $("dirtyPill").style.display = DIRTY ? "flex" : "none";
        }

        function stopWheelChaining(e) {
            const el = $("modalBody");
            const delta = e.deltaY;
            const atTop = el.scrollTop <= 0;
            const atBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 1;
            if ((delta < 0 && atTop) || (delta > 0 && atBottom)) e.preventDefault();
        }

        function openModal(title, html) {
            $("modalTitle").textContent = title;
            $("modalBody").innerHTML = html;

            $("modalBack").classList.add("show");
            $("modalBack").setAttribute("aria-hidden", "false");
            document.body.classList.add("modal-open");

            $("modalBody").scrollTop = 0;
            $("modalBody").addEventListener("wheel", stopWheelChaining, { passive: false });
        }

        function closeModal() {
            $("modalBack").classList.remove("show");
            $("modalBack").setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            $("modalBody").removeEventListener("wheel", stopWheelChaining);
            $("modalBody").innerHTML = "";
        }

        function nlToBr(s) {
            const v = String(s ?? "").replace(/\r\n/g, "\n");
            return v.split("\n").map(x => x.trimEnd()).join("<br/>");
        }

        function brToNl(s) {
            return String(s ?? "")
                .replaceAll("<br/>", "\n")
                .replaceAll("<br>", "\n")
                .replaceAll("<br />", "\n");
        }

        function placeholderSvg(title) {
            return `data:image/svg+xml;utf8,
                <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
                  <defs>
                    <linearGradient id="g" x1="0" x2="1">
                      <stop offset="0" stop-color="%2307070a"/>
                      <stop offset="1" stop-color="%23151622"/>
                    </linearGradient>
                    <radialGradient id="r" cx="25%" cy="20%" r="70%">
                      <stop offset="0" stop-color="%23f6d365" stop-opacity="0.20"/>
                      <stop offset="1" stop-color="%23d6ae54" stop-opacity="0"/>
                    </radialGradient>
                  </defs>
                  <rect width="100%" height="100%" fill="url(%23g)"/>
                  <circle cx="320" cy="170" r="420" fill="url(%23r)"/>
                  <rect x="120" y="210" width="960" height="460" rx="48" fill="%23ffffff" fill-opacity="0.06" stroke="%23ffffff" stroke-opacity="0.12"/>
                  <text x="160" y="350" font-size="54" fill="%23ffffff" fill-opacity="0.92" font-family="Arial">${escapeXml(title || "Piatto")}</text>
                  <text x="160" y="420" font-size="28" fill="%23ffffff" fill-opacity="0.62" font-family="Arial">foto in arrivo ✨</text>
                </svg>`;
        }

        function resolveImageSrc(imageUrl, fallbackTitle) {
            const v = String(imageUrl || "").trim();
            if (!v) return placeholderSvg(fallbackTitle || "Piatto");
            if (v.startsWith("data:image/") || v.startsWith("http://") || v.startsWith("https://") || v.startsWith("blob:")) return v;
            return v;
        }

        /******************************************************************
         * ID UTILS
         ******************************************************************/
        function genId() {
            try { if (typeof crypto !== "undefined" && crypto.randomUUID) return crypto.randomUUID(); } catch (e) { }
            return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
        }

        function ensureItemIds(menu) {
            if (!menu || !menu.itemsBySection) return;
            for (const key of Object.keys(menu.itemsBySection)) {
                const arr = Array.isArray(menu.itemsBySection[key]) ? menu.itemsBySection[key] : [];
                for (const it of arr) {
                    if (!it.id) it.id = genId();
                }
            }
        }

        function setupThemeScrollMotion() {
            let ticking = false;

            // ✅ MOBILE: lo sfondo tema viene applicato direttamente su <body> (vedi CSS @media),
            // quindi evito l'animazione JS che su iOS/Android può "laggare".
            const isMobile = window.matchMedia("(max-width: 980px)").matches;
            if (isMobile) {
                document.documentElement.style.setProperty("--themeScrollY", "0px");
                return;
            }

            function update() {
                ticking = false;
                // muovi verso l’alto mentre scrolli verso il basso (effetto “loop”)
                const y = window.scrollY || 0;
                document.documentElement.style.setProperty("--themeScrollY", `${-y}px`);
            }

            window.addEventListener("scroll", () => {
                if (!ticking) {
                    ticking = true;
                    requestAnimationFrame(update);
                }
            }, { passive: true });

            update();
        }


        /******************************************************************
         * DEFAULT DATA
         ******************************************************************/
        const DEFAULT_DATA = {
            cover: {
                browserTitle: "Menu della Serata • Casa Edition",
                heroPrefix: "Stasera a casa con Chef Massy:",
                heroGold: "cena da 3 stelle",
                heroDesc: "Un menu completo, elegante e moderno.\nPresentato in modo “wow” come fosse un fine-dining,\nma con il calore di una serata tra amici e famiglia.",

                role1Label: "Chef della serata",
                role1Name: "Massimiliano Giannone",
                role2Label: "Animazione della serata",
                role2Name: "Anna Maria",

                sideLeftImageUrl: "",
                sideRightImageUrl: "",

                /* ✅ theme pattern */
                themePatternUrl: "",
                themePatternSize: 420,
                /* ✅ base background color (optional, e.g. halloween orange) */
                baseBgColor: "",

                toast: "“Questa sera ci prendiamo un momento per stare insieme, mangiare bene e fare due risate.\nIo cucino, voi godetevela.”",
                metaOrario: "06/01/2026\nalle ore 20:30",
                metaNote: "Chiedimi per allergeni o alternative.\nPiatti serviti “a ondate”."
            },
            sections: [
                { key: "antipasti", title: "Antipasti", desc: "Il benvenuto (piccoli assaggi, grande impatto)" },
                { key: "primi", title: "Primi", desc: "La portata che fa innamorare" },
                { key: "secondi", title: "Secondi", desc: "Il piatto protagonista" },
                { key: "dolci", title: "Dolci", desc: "Finale morbido, felice, memorabile" },
                { key: "bevande", title: "Bevande", desc: "Durante la serata (scegli, abbina, brinda)" }
            ],
            itemsBySection: {
                antipasti: [
                    { id: genId(), name: "Bruschette gourmet", info: "Croccanti, profumate, con topping ricchi e servite “a degustazione”.", imageUrl: "" },
                    { id: genId(), name: "Spritz", info: "Leggero e frizzante, perfetto per aprire la serata con stile.", imageUrl: "" }
                ],
                primi: [
                    { id: genId(), name: "Pasta con gamberi e stracciatella", info: "Gamberi cotti con vino bianco, bisk di gambero, stracciatella e gambero rosso crudo: cremoso, saporito e fresco.", imageUrl: "" }
                ],
                secondi: [
                    { id: genId(), name: "Pesce spada in crosta di pistacchio", info: "Rosolato con vino bianco e brodo di pesce chiarificato, servito con fondo e crosta di pistacchio: delicato e sorprendente.", imageUrl: "" }
                ],
                dolci: [
                    { id: genId(), name: "Cannolo siciliano", info: "Cremoso e croccante: un classico che chiude la serata con il sapore della nostra terra.", imageUrl: "" }
                ],
                bevande: [
                    { id: genId(), name: "Acqua liscia", info: "Sempre in tavola, servita fresca.", imageUrl: "" },
                    { id: genId(), name: "[Inserisci qui i vini della serata]", info: "Esempio:\nBianco fresco per antipasti\nRosso morbido per i secondi\nBollicine per brindare", imageUrl: "" },
                    { id: genId(), name: "Coca-Cola", info: "Classica e fresca.", imageUrl: "" },
                    { id: genId(), name: "Birre", info: "Birre presenti:\nPeroni\nBirra Messina", imageUrl: "" },
                    { id: genId(), name: "Acqua frizzante", info: "Per chi la preferisce frizzante.", imageUrl: "" }
                ]
            }
        };

        /******************************************************************
         * STORAGE + REMOTE LOADING
         ******************************************************************/
        function saveMenuToLocal(data) {
            try { localStorage.setItem(MENU_KEY, JSON.stringify(data)); return true; }
            catch (err) { return false; }
        }

        function normalizeMenuData(parsed) {
            if (!parsed || typeof parsed !== "object") return deepClone(DEFAULT_DATA);

            parsed.cover = parsed.cover || {};

            if (!parsed.cover.browserTitle) parsed.cover.browserTitle = DEFAULT_DATA.cover.browserTitle;

            parsed.cover.heroDesc = brToNl(parsed.cover.heroDesc ?? DEFAULT_DATA.cover.heroDesc);
            parsed.cover.toast = brToNl(parsed.cover.toast ?? DEFAULT_DATA.cover.toast);
            parsed.cover.metaOrario = brToNl(parsed.cover.metaOrario ?? DEFAULT_DATA.cover.metaOrario);
            parsed.cover.metaNote = brToNl(parsed.cover.metaNote ?? DEFAULT_DATA.cover.metaNote);

            if (!parsed.cover.role1Label) parsed.cover.role1Label = DEFAULT_DATA.cover.role1Label;
            if (parsed.cover.role1Name == null) parsed.cover.role1Name = DEFAULT_DATA.cover.role1Name;

            if (!parsed.cover.role2Label) parsed.cover.role2Label = DEFAULT_DATA.cover.role2Label;
            if (parsed.cover.role2Name == null) parsed.cover.role2Name = DEFAULT_DATA.cover.role2Name;

            if (parsed.cover.sideLeftImageUrl == null) parsed.cover.sideLeftImageUrl = DEFAULT_DATA.cover.sideLeftImageUrl;
            if (parsed.cover.sideRightImageUrl == null) parsed.cover.sideRightImageUrl = DEFAULT_DATA.cover.sideRightImageUrl;

            /* ✅ theme pattern */
            if (parsed.cover.themePatternUrl == null) parsed.cover.themePatternUrl = DEFAULT_DATA.cover.themePatternUrl;
            const sizeNum = Number(parsed.cover.themePatternSize ?? DEFAULT_DATA.cover.themePatternSize);
            parsed.cover.themePatternSize = Number.isFinite(sizeNum) && sizeNum >= 80 ? Math.round(sizeNum) : DEFAULT_DATA.cover.themePatternSize;

            /* ✅ base background color (optional) */
            if (parsed.cover.baseBgColor == null) parsed.cover.baseBgColor = DEFAULT_DATA.cover.baseBgColor;
            parsed.cover.baseBgColor = String(parsed.cover.baseBgColor || "").trim();

            parsed.sections = Array.isArray(parsed.sections) ? parsed.sections : deepClone(DEFAULT_DATA.sections);
            parsed.itemsBySection = parsed.itemsBySection || deepClone(DEFAULT_DATA.itemsBySection);

            ensureItemIds(parsed);
            return parsed;
        }

        function loadMenuFromLocal() {
            const raw = localStorage.getItem(MENU_KEY);
            if (!raw) saveMenuToLocal(deepClone(DEFAULT_DATA));

            const parsed = safeParseJson(localStorage.getItem(MENU_KEY));
            if (!parsed) {
                saveMenuToLocal(deepClone(DEFAULT_DATA));
                return deepClone(DEFAULT_DATA);
            }
            return normalizeMenuData(parsed);
        }

        async function loadMenuAsync() {
            try {
                const res = await fetch(REMOTE_DATA_FILE, { cache: "no-store" });
                if (res.ok) {
                    const txt = await res.text();
                    const data = JSON.parse(txt);
                    const norm = normalizeMenuData(data);
                    return norm;
                }
            } catch (e) { }
            return loadMenuFromLocal();
        }

        /******************************************************************
         * SESSION
         ******************************************************************/
        function isAdmin() { return localStorage.getItem(SESSION_KEY) === "1"; }
        function logout() { localStorage.removeItem(SESSION_KEY); }

        /******************************************************************
         * APPLY THEME PATTERN + ✅ CHANGE BASE BACKGROUND
         ******************************************************************/
        function buildColorBg(color) {
            // colore base + un minimo di profondità (senza “spaccare” lo stile)
            const c = String(color || "").trim();
            if (!c) return "";
            return `radial-gradient(1200px 600px at 15% -10%, rgba(246,211,101,.14), transparent 60%),
                    radial-gradient(900px 500px at 90% 10%, rgba(202,162,74,.12), transparent 55%),
                    radial-gradient(800px 500px at 50% 110%, rgba(120,90,200,.08), transparent 55%),
                    linear-gradient(180deg, ${c} 0%, ${c} 100%)`;
        }

        /******************************************************************
         * APPLY THEME PATTERN + ✅ CHANGE BASE BACKGROUND (NOW WITH CUSTOM COLOR)
         ******************************************************************/
        function applyThemePattern(url, sizePx, baseBgColor) {
            const u = String(url || "").trim();
            const baseColor = String(baseBgColor || "").trim();

            // 1) pattern
            if (!u) {
                document.documentElement.style.setProperty("--themePattern", "none");
            } else {
                const src = resolveImageSrc(u, "Tema");
                document.documentElement.style.setProperty("--themePattern", `url("${src}")`);
            }

            // 2) base background (default / themed / custom color)
            const custom = buildColorBg(baseColor);
            if (custom) {
                document.documentElement.style.setProperty("--baseBgApplied", custom);
                document.documentElement.style.setProperty("--baseBgColor", baseColor);
            } else {
                // se non hai un colore custom, scegli in base alla presenza del tema
                const fallback = u ? "var(--baseBgThemed)" : "var(--baseBgDefault)";
                document.documentElement.style.setProperty("--baseBgApplied", fallback);
                document.documentElement.style.setProperty("--baseBgColor", "");
            }

            // manteniamo anche --baseBg per compatibilità (non obbligatorio, ma utile se hai CSS che lo usa)
            document.documentElement.style.setProperty("--baseBg", "var(--baseBgApplied)");

            // 3) size
            const s = Number(sizePx);
            if (Number.isFinite(s) && s >= 80) {
                document.documentElement.style.setProperty("--themePatternSize", `${Math.round(s)}px`);
            } else {
                document.documentElement.style.setProperty("--themePatternSize", `${DEFAULT_DATA.cover.themePatternSize}px`);
            }
        }

        /******************************************************************
         * MOBILE LAYOUT HELPERS
         ******************************************************************/
        function relocateSidePortraitsForMobile() {
            const left = document.getElementById("sideLeft");
            const right = document.getElementById("sideRight");

            const hasValidImg = (el) => {
                const img = el ? el.querySelector("img") : null;
                const src = img ? (img.getAttribute("src") || "") : "";
                return !!src && src.trim().length > 0 && !src.startsWith("data:image/svg+xml");; // dataURL o URL
            };

            // Non spostare mai le foto: restano FIXED ai bordi (desktop + mobile)
            const anySide = hasValidImg(left) || hasValidImg(right);
            document.body.classList.toggle("hasSidePortraits", anySide);

            if (left) left.style.display = hasValidImg(left) ? "block" : "none";
            if (right) right.style.display = hasValidImg(right) ? "block" : "none";
        }


        function setSidePortrait(which, url) {
            const box = document.getElementById(which === "L" ? "sideLeft" : "sideRight");
            const img = document.getElementById(which === "L" ? "sideLeftImg" : "sideRightImg");
            if (!box || !img) return;

            const v = String(url || "").trim();

            // ✅ Se non c'è una foto: NASCONDI COMPLETAMENTE (evita testo alt "foto sinistra/destra")
            if (!v) {
                box.style.display = "none";
                box.setAttribute("data-empty", "1");
                img.removeAttribute("src");
                relocateSidePortraitsForMobile();
                return;
            }

            // ✅ Se c'è una foto: mostra e usa l'URL così com'è (Niente placeholder)
            box.style.display = "block";
            box.removeAttribute("data-empty");

            // supporta data:image / http(s) / blob / path locale (immage/...)
            img.src = resolveImageSrc(v, ""); // fallback title vuoto: per side portraits non vogliamo placeholder
            relocateSidePortraitsForMobile();
        }

        /******************************************************************
         * RENDER
         ******************************************************************/
        function setBrowserTitle(title) {
            const t = String(title || DEFAULT_DATA.cover.browserTitle);
            document.title = t;
            const titleEl = document.querySelector("head title");
            if (titleEl) titleEl.textContent = t;
        }

        function renderPublic(menu, adminMode) {
            menu = normalizeMenuData(menu);

            setBrowserTitle(menu.cover.browserTitle);

            // roles
            $("role1Label").textContent = menu.cover.role1Label || DEFAULT_DATA.cover.role1Label;
            $("role1Name").textContent = menu.cover.role1Name || "";
            $("role2Label").textContent = menu.cover.role2Label || DEFAULT_DATA.cover.role2Label;
            $("role2Name").textContent = menu.cover.role2Name || "";

            // side portraits
            setSidePortrait("L", menu.cover.sideLeftImageUrl);
            setSidePortrait("R", menu.cover.sideRightImageUrl);

            // ✅ theme
            applyThemePattern(menu.cover.themePatternUrl, menu.cover.themePatternSize, menu.cover.baseBgColor);

            $("heroPrefix").textContent = menu.cover.heroPrefix || "";
            $("heroGold").textContent = menu.cover.heroGold || "";

            $("heroDesc").innerHTML = nlToBr(menu.cover.heroDesc || "");
            $("toastText").innerHTML = nlToBr(menu.cover.toast || "");
            $("metaOrario").innerHTML = nlToBr(menu.cover.metaOrario || "");
            $("metaNote").innerHTML = nlToBr(menu.cover.metaNote || "");

            $("editEventBtn").style.display = adminMode ? "inline-flex" : "none";

            const root = $("menuRoot");
            root.innerHTML = "";

            for (const section of menu.sections) {
                const items = (menu.itemsBySection && menu.itemsBySection[section.key]) ? menu.itemsBySection[section.key] : [];

                const sectionEl = document.createElement("section");
                sectionEl.className = "section";
                sectionEl.setAttribute("aria-label", section.title);

                const actionsHtml = adminMode ? `
                  <div class="sectionActions">
                    <button class="miniBtn" title="Aggiungi" data-add="${escapeXml(section.key)}">+</button>
                  </div>
                ` : `<div></div>`;

                sectionEl.innerHTML = `
                  <div class="sectionHead">
                    <h2><span class="dot" aria-hidden="true"></span> ${escapeXml(section.title)}</h2>
                    <div style="display:flex; align-items:baseline; gap:12px;">
                      <p class="desc">${escapeXml(section.desc || "")}</p>
                      ${actionsHtml}
                    </div>
                  </div>
                  <div class="grid" data-section="${escapeXml(section.key)}"></div>
                `;

                const grid = sectionEl.querySelector(".grid");

                items.forEach((it, idx) => {
                    const imgSrc = resolveImageSrc(it.imageUrl, it.name || "Piatto");

                    const card = document.createElement("article");
                    card.className = "card";
                    card.setAttribute("data-idx", String(idx));
                    card.setAttribute("data-sec", section.key);
                    card.setAttribute("data-id", String(it.id || ""));

                    card.innerHTML = `
                    <div class="img">
                      ${adminMode ? `
                        <div class="dragBtnWrap">
                          <button class="dragBtn" title="Trascina per riordinare" data-drag-handle="1">⠿</button>
                        </div>
                        <div class="cardBtnsRight">
                          <button class="editBtn" title="Modifica" data-edit="${escapeXml(section.key)}:${idx}">✏️</button>
                          <button class="delBtn" title="Elimina" data-del="${escapeXml(section.key)}:${idx}">−</button>
                        </div>
                      ` : ``}
                      <img alt="${escapeXml(it.name || "Piatto")}" src="${imgSrc}">
                    </div>
                    <div class="content">
                      <h3 class="name">${escapeXml(it.name || "")}</h3>
                      <p class="info">${escapeXml(it.info || "")}</p>
                    </div>
                  `;
                    grid.appendChild(card);
                });

                root.appendChild(sectionEl);
            }

            document.querySelectorAll('.section .grid').forEach(grid => {
                const count = grid.querySelectorAll('.card').length;
                if (count > 0 && count < 3) {
                    grid.classList.add('center-few');
                    grid.style.setProperty('--cols', String(count));
                } else {
                    grid.classList.remove('center-few');
                    grid.style.removeProperty('--cols');
                }
            });

            if (adminMode) {
                document.querySelectorAll("[data-add]").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const key = btn.getAttribute("data-add");
                        openCreateModal(key);
                    });
                });

                document.querySelectorAll("[data-del]").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const v = btn.getAttribute("data-del");
                        const [sec, idxStr] = v.split(":");
                        deleteItem(sec, Number(idxStr));
                    });
                });

                document.querySelectorAll("[data-edit]").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const v = btn.getAttribute("data-edit");
                        const [sec, idxStr] = v.split(":");
                        openEditModal(sec, Number(idxStr));
                    });
                });

                attachDnDHandlers();
            }
        }

        function ensureDraft() {
            if (!DRAFT) DRAFT = deepClone(MENU);
            DRAFT = normalizeMenuData(DRAFT);
            if (!DRAFT.itemsBySection) DRAFT.itemsBySection = {};
            if (!DRAFT.cover) DRAFT.cover = deepClone(DEFAULT_DATA.cover);
            ensureItemIds(DRAFT);
        }

        /******************************************************************
         * (DRAG + CRUD ITEMS)  (UNCHANGED)
         ******************************************************************/
        let DRAG = {
            active: false, sectionKey: null, gridEl: null, cardEl: null, placeholderEl: null, ghostEl: null,
            pointerId: null, offsetX: 0, offsetY: 0, targetCard: null, insertAfter: false, raf: 0
        };

        function clearDropHints(grid) {
            if (!grid) return;
            grid.querySelectorAll(".card.drop-before, .card.drop-after").forEach(el => {
                el.classList.remove("drop-before", "drop-after");
            });
        }

        function cleanupDrag() {
            if (DRAG.raf) cancelAnimationFrame(DRAG.raf);
            DRAG.raf = 0;

            if (DRAG.gridEl) clearDropHints(DRAG.gridEl);
            if (DRAG.cardEl) DRAG.cardEl.style.display = "";

            if (DRAG.placeholderEl?.parentElement) DRAG.placeholderEl.parentElement.removeChild(DRAG.placeholderEl);
            if (DRAG.ghostEl?.parentElement) DRAG.ghostEl.parentElement.removeChild(DRAG.ghostEl);

            window.removeEventListener("pointermove", onPointerMove, { passive: false });
            window.removeEventListener("pointerup", onPointerUp, { passive: false });
            window.removeEventListener("pointercancel", onPointerCancel, { passive: false });

            document.body.style.userSelect = "";

            DRAG = {
                active: false, sectionKey: null, gridEl: null, cardEl: null, placeholderEl: null, ghostEl: null,
                pointerId: null, offsetX: 0, offsetY: 0, targetCard: null, insertAfter: false, raf: 0
            };
        }

        function positionGhost(clientX, clientY) {
            if (!DRAG.ghostEl) return;
            const x = clientX - DRAG.offsetX;
            const y = clientY - DRAG.offsetY;
            DRAG.ghostEl.style.left = x + "px";
            DRAG.ghostEl.style.top = y + "px";
        }

        function pickTargetFromPointer(clientX, clientY) {
            const grid = DRAG.gridEl;
            if (!grid) return { card: null, after: false };

            const cards = [...grid.querySelectorAll(".card")].filter(c => c.style.display !== "none");
            if (cards.length === 0) return { card: null, after: false };

            let best = null;
            let bestDist = Infinity;

            for (const c of cards) {
                const r = c.getBoundingClientRect();
                const cx = r.left + r.width / 2;
                const cy = r.top + r.height / 2;
                const dx = clientX - cx;
                const dy = clientY - cy;
                const d = dx * dx + dy * dy;
                if (d < bestDist) { bestDist = d; best = { el: c, rect: r }; }
            }

            if (!best) return { card: null, after: false };

            const r = best.rect;
            const cx = r.left + r.width / 2;
            const cy = r.top + r.height / 2;

            const sameRow = Math.abs(clientY - cy) < r.height * 0.35;
            const after = sameRow ? (clientX > cx) : (clientY > cy);

            return { card: best.el, after };
        }

        function applyDropHint(card, after) {
            if (DRAG.targetCard) {
                DRAG.targetCard.classList.remove("drop-before", "drop-after");
            }
            DRAG.targetCard = card;
            DRAG.insertAfter = !!after;

            if (card) {
                card.classList.toggle("drop-after", !!after);
                card.classList.toggle("drop-before", !after);
            }
        }

        function startDragFromHandle(handleEl, e) {
            const card = handleEl.closest(".card");
            if (!card) return;

            const sec = card.getAttribute("data-sec");
            const grid = card.closest(".grid[data-section]");
            if (!sec || !grid) return;
            if (!document.body.classList.contains("admin")) return;

            e.preventDefault();

            DRAG.active = true;
            DRAG.sectionKey = sec;
            DRAG.gridEl = grid;
            DRAG.cardEl = card;
            DRAG.pointerId = e.pointerId;

            document.body.style.userSelect = "none";

            const ph = document.createElement("div");
            ph.className = "dragPlaceholder";
            ph.style.minHeight = (card.offsetHeight || 260) + "px";
            grid.insertBefore(ph, card);
            DRAG.placeholderEl = ph;

            card.style.display = "none";

            const ghost = card.cloneNode(true);
            ghost.classList.add("dragGhost");
            ghost.style.width = (ph.getBoundingClientRect().width || 320) + "px";
            document.body.appendChild(ghost);
            DRAG.ghostEl = ghost;

            const r = ph.getBoundingClientRect();
            DRAG.offsetX = e.clientX - r.left;
            DRAG.offsetY = e.clientY - r.top;

            positionGhost(e.clientX, e.clientY);

            try { handleEl.setPointerCapture(e.pointerId); } catch { }

            const t = pickTargetFromPointer(e.clientX, e.clientY);
            applyDropHint(t.card, t.after);

            window.addEventListener("pointermove", onPointerMove, { passive: false });
            window.addEventListener("pointerup", onPointerUp, { passive: false });
            window.addEventListener("pointercancel", onPointerCancel, { passive: false });
        }

        function onPointerMove(e) {
            if (!DRAG.active || e.pointerId !== DRAG.pointerId) return;
            e.preventDefault();

            positionGhost(e.clientX, e.clientY);

            if (DRAG.raf) return;
            DRAG.raf = requestAnimationFrame(() => {
                DRAG.raf = 0;
                const t = pickTargetFromPointer(e.clientX, e.clientY);
                applyDropHint(t.card, t.after);
            });
        }

        function onPointerUp(e) {
            if (!DRAG.active || e.pointerId !== DRAG.pointerId) return;
            e.preventDefault();

            const grid = DRAG.gridEl;
            const card = DRAG.cardEl;
            const ph = DRAG.placeholderEl;
            const target = DRAG.targetCard;
            const after = DRAG.insertAfter;

            if (grid && card) {
                card.style.display = "";
                clearDropHints(grid);

                if (target && grid.contains(target)) {
                    if (after) grid.insertBefore(card, target.nextSibling);
                    else grid.insertBefore(card, target);
                } else {
                    grid.appendChild(card);
                }

                if (ph?.parentElement) ph.parentElement.removeChild(ph);
                commitOrderFromDom(DRAG.sectionKey, grid);
            }

            cleanupDrag();
        }

        function onPointerCancel(e) {
            if (!DRAG.active || e.pointerId !== DRAG.pointerId) return;
            cleanupDrag();
        }

        function attachDnDHandlers() {
            document.querySelectorAll("[data-drag-handle]").forEach(h => {
                if (h.__hasDrag) return;
                h.__hasDrag = true;
                h.addEventListener("pointerdown", (e) => startDragFromHandle(h, e), { passive: false });
            });
        }

        function commitOrderFromDom(sectionKey, gridEl) {
            ensureDraft();

            const idsInDom = [...gridEl.querySelectorAll(".card")]
                .map(c => c.getAttribute("data-id"))
                .filter(Boolean);

            const current = DRAFT.itemsBySection[sectionKey] || [];
            const map = new Map(current.map(it => [String(it.id), it]));

            const next = [];
            for (const id of idsInDom) {
                const it = map.get(String(id));
                if (it) next.push(it);
            }
            for (const it of current) {
                if (!idsInDom.includes(String(it.id))) next.push(it);
            }

            DRAFT.itemsBySection[sectionKey] = next;
            setDirty(true);

            renderPublic(DRAFT, true);
        }

        function openCreateModal(sectionKey) {
            ensureDraft();
            const empty = { id: genId(), name: "", info: "", imageUrl: "" };
            openItemModal("Aggiungi piatto", empty, (savedItem) => {
                const list = DRAFT.itemsBySection[sectionKey] || (DRAFT.itemsBySection[sectionKey] = []);
                list.push(savedItem);
                setDirty(true);
                renderPublic(DRAFT, true);
            });
        }

        function openEditModal(sectionKey, idx) {
            ensureDraft();
            const list = DRAFT.itemsBySection[sectionKey] || [];
            const it = list[idx];
            if (!it) return;
            openItemModal("Modifica piatto", deepClone(it), (savedItem) => {
                savedItem.id = it.id || savedItem.id || genId();
                list[idx] = savedItem;
                setDirty(true);
                renderPublic(DRAFT, true);
            }, true);
        }

        function deleteItem(sectionKey, idx) {
            ensureDraft();
            const list = DRAFT.itemsBySection[sectionKey] || [];
            const it = list[idx];
            if (!it) return;

            openModal("Elimina", `
                <div class="panel">
                  <b style="letter-spacing:.18em; text-transform:uppercase; font-size:12px;">Conferma</b>
                  <p class="mini">Vuoi eliminare: <b>${escapeXml(it.name || "(senza nome)")}</b>?</p>
                  <div class="right">
                    <button class="btn" id="cancelDel" type="button">Annulla</button>
                    <button class="btn danger" id="doDel" type="button">Elimina</button>
                  </div>
                </div>
              `);

            setTimeout(() => {
                const c = document.getElementById("cancelDel");
                const d = document.getElementById("doDel");
                if (c) c.onclick = closeModal;
                if (d) d.onclick = () => {
                    list.splice(idx, 1);
                    setDirty(true);
                    renderPublic(DRAFT, true);
                    closeModal();
                };
            }, 0);
        }

        /******************************************************************
         * ITEM MODAL (unchanged)
         ******************************************************************/
        function openItemModal(title, item, onSave, allowEmptyName = false) {
            const currentImg = (item.imageUrl && String(item.imageUrl).trim()) ? String(item.imageUrl).trim() : "";
            const preview = resolveImageSrc(currentImg, item.name || "Piatto");

            openModal(title, `
                <div class="panel">
                  <div class="row">
                    <label>Titolo</label>
                    <input id="fName" type="text" value="${escapeXml(item.name || "")}" placeholder="Es: Bruschette gourmet" />
                  </div>

                  <div class="row">
                    <label>Descrizione</label>
                    <textarea id="fInfo" placeholder="Descrizione breve...">${escapeXml(item.info || "")}</textarea>
                  </div>

                  <div class="row">
                    <label>Immagine</label>
                    <div class="fileRow">
                      <div class="thumb"><img id="imgPreview" alt="preview" src="${preview}"></div>

                      <div class="fileActions">
                        <input id="fFile" type="file" accept="image/*" style="display:none" />
                        <button class="btn" id="pickFile" type="button">📷 Seleziona file</button>
                        <button class="btn danger" id="clearImg" type="button">Rimuovi</button>
                      </div>

                      <div class="mini">
                        ✅ Selezionando un file, nel JSON verrà salvato:
                        <b>${escapeXml(IMAGES_FOLDER)}nomefile.jpg</b><br/>
                        Poi devi copiare quel file dentro <b>${escapeXml(IMAGES_FOLDER)}</b> prima di caricare su GitHub.
                      </div>

                      <div class="mini">Oppure incolla un URL (opzionale):</div>
                      <input id="fImgUrl" type="text"
                        value="${escapeXml(currentImg && (currentImg.startsWith("http://") || currentImg.startsWith("https://")) ? currentImg : "")}"
                        placeholder="https://..." />
                    </div>
                  </div>

                  <div class="right">
                    <button class="btn" id="cancelItem" type="button">Annulla</button>
                    <button class="btn ok" id="saveItem" type="button">Conferma</button>
                  </div>
                </div>
              `);

            setTimeout(() => {
                const cancel = document.getElementById("cancelItem");
                const save = document.getElementById("saveItem");
                const nameEl = document.getElementById("fName");

                const pickFileBtn = document.getElementById("pickFile");
                const fileInput = document.getElementById("fFile");
                const clearBtn = document.getElementById("clearImg");
                const previewImg = document.getElementById("imgPreview");
                const urlInput = document.getElementById("fImgUrl");

                let modalImageValue = currentImg;
                let localPreviewObjectUrl = "";

                function setPreview(src) {
                    previewImg.src = resolveImageSrc(src, nameEl.value || "Piatto");
                }
                function revokeLocalPreview() {
                    if (localPreviewObjectUrl) {
                        try { URL.revokeObjectURL(localPreviewObjectUrl); } catch { }
                        localPreviewObjectUrl = "";
                    }
                }

                if (cancel) cancel.onclick = () => { revokeLocalPreview(); closeModal(); };

                if (pickFileBtn && fileInput) {
                    pickFileBtn.onclick = () => fileInput.click();
                    fileInput.onchange = () => {
                        const file = fileInput.files && fileInput.files[0];
                        if (!file) return;

                        modalImageValue = IMAGES_FOLDER + file.name;

                        revokeLocalPreview();
                        localPreviewObjectUrl = URL.createObjectURL(file);
                        previewImg.src = localPreviewObjectUrl;

                        if (urlInput) urlInput.value = "";
                    };
                }

                if (clearBtn) {
                    clearBtn.onclick = () => {
                        revokeLocalPreview();
                        modalImageValue = "";
                        if (fileInput) fileInput.value = "";
                        if (urlInput) urlInput.value = "";
                        setPreview("");
                    };
                }

                if (urlInput) {
                    urlInput.addEventListener("input", () => {
                        const v = urlInput.value.trim();
                        if (v) {
                            revokeLocalPreview();
                            modalImageValue = v;
                            setPreview(v);
                        } else {
                            if (modalImageValue && (modalImageValue.startsWith("http://") || modalImageValue.startsWith("https://"))) {
                                modalImageValue = "";
                                setPreview("");
                            }
                        }
                    });
                }

                if (nameEl) {
                    nameEl.addEventListener("input", () => {
                        if (!modalImageValue) setPreview("");
                    });
                }

                if (save) save.onclick = () => {
                    const name = document.getElementById("fName").value.trim();
                    const info = document.getElementById("fInfo").value;
                    const url = (document.getElementById("fImgUrl").value || "").trim();

                    let finalImg = modalImageValue;
                    if (url) finalImg = url;

                    if (!allowEmptyName && !name) {
                        nameEl.focus();
                        nameEl.style.borderColor = "rgba(255,91,107,.75)";
                        return;
                    }

                    onSave({
                        id: item.id || genId(),
                        name: name || "(senza nome)",
                        info: String(info ?? "").replace(/\r\n/g, "\n"),
                        imageUrl: String(finalImg || "").trim()
                    });

                    revokeLocalPreview();
                    closeModal();
                };
            }, 0);
        }

        /******************************************************************
         * EVENT MODAL (unchanged except theme already present)
         ******************************************************************/
        function openEventModal() {
            ensureDraft();
            const c = DRAFT.cover;

            const patternPreview = c.themePatternUrl ? resolveImageSrc(c.themePatternUrl, "Tema") : "";

            openModal("Modifica evento", `
                <div class="panel">

                  <div class="row">
                    <label>Titolo browser</label>
                    <input id="eBrowserTitle" type="text" value="${escapeXml(c.browserTitle || "")}" />
                  </div>

                  <hr style="border:0; border-top:1px solid rgba(255,255,255,.10); margin:14px 0; opacity:.7" />

                  <div class="row">
                    <label>Tema sito (pattern)</label>
                    <div class="fileRow">
                      <div class="thumb"><img id="prevPattern" alt="preview pattern" src="${patternPreview || resolveImageSrc("", "Tema")}"></div>

                      <div class="fileActions">
                        <input id="eFilePattern" type="file" accept="image/*" style="display:none" />
                        <button class="btn" id="pickPattern" type="button">🖼️ Seleziona immagine tema</button>
                        <button class="btn danger" id="clearPattern" type="button">Rimuovi tema</button>
                      </div>

                      <div class="row" style="margin-top:0;">
                        <label>Dimensione pattern (px)</label>
                        <input id="ePatternSize" type="number" min="80" step="10" value="${escapeXml(String(c.themePatternSize ?? DEFAULT_DATA.cover.themePatternSize))}" />
                      </div>

                      <div class="mini">
                        Il tema è un’immagine ripetuta in loop mentre scrolli (repeat).<br/>
                        ✅ Nel JSON si salva solo <b>${escapeXml(IMAGES_FOLDER)}nomefile.ext</b> se selezioni un file.
                      </div>

                      <div class="mini">Oppure incolla un URL immagine (opzionale):</div>
                      <input id="ePatternUrl" type="text" value="${escapeXml((c.themePatternUrl || "").startsWith("http") ? c.themePatternUrl : "")}" placeholder="https://...">
                      <div class="row" style="margin-top:10px;">
                        <label>Colore sfondo (opzionale)</label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                          <input id="eBaseBgColor" type="text" value="${escapeXml(String(c.baseBgColor || ""))}" placeholder="#ff7a00 (Halloween)" style="flex:1; min-width:180px;" />
                          <input id="eBaseBgColorPick" type="color" value="${escapeXml((String(c.baseBgColor || "").trim() && String(c.baseBgColor || "").trim().startsWith('#') && String(c.baseBgColor || "").trim().length >= 4) ? String(c.baseBgColor || "").trim() : "#ff7a00")}" style="width:54px; height:44px; padding:0; border-radius:12px;" />
                          <button class="btn danger" id="clearBaseBgColor" type="button">Reset</button>
                        </div>
                      </div>

                    </div>
                  </div>

                  <hr style="border:0; border-top:1px solid rgba(255,255,255,.10); margin:14px 0; opacity:.7" />

                  <div class="row">
                    <label>Ruolo 1 (sopra)</label>
                    <input id="eRole1Label" type="text" value="${escapeXml(c.role1Label || "")}" />
                  </div>
                  <div class="row">
                    <label>Ruolo 1 (nome sotto)</label>
                    <input id="eRole1Name" type="text" value="${escapeXml(c.role1Name || "")}" />
                  </div>

                  <div class="row">
                    <label>Ruolo 2 (sopra)</label>
                    <input id="eRole2Label" type="text" value="${escapeXml(c.role2Label || "")}" />
                  </div>
                  <div class="row">
                    <label>Ruolo 2 (nome sotto)</label>
                    <input id="eRole2Name" type="text" value="${escapeXml(c.role2Name || "")}" />
                  </div>

                  <div class="row">
                    <label>Foto sinistra</label>
                    <div class="fileRow">
                      <div class="thumb"><img id="prevLeft" alt="preview left" src="${resolveImageSrc(c.sideLeftImageUrl, "Foto sinistra")}"></div>
                      <div class="fileActions">
                        <input id="eFileLeft" type="file" accept="image/*" style="display:none" />
                        <button class="btn" id="pickLeft" type="button">📷 Seleziona file</button>
                        <button class="btn danger" id="clearLeft" type="button">Rimuovi</button>
                      </div>
                      <div class="mini">Verrà salvato: <b>${escapeXml(IMAGES_FOLDER)}nomefile.jpg</b></div>
                    </div>
                  </div>

                  <div class="row">
                    <label>Foto destra</label>
                    <div class="fileRow">
                      <div class="thumb"><img id="prevRight" alt="preview right" src="${resolveImageSrc(c.sideRightImageUrl, "Foto destra")}"></div>
                      <div class="fileActions">
                        <input id="eFileRight" type="file" accept="image/*" style="display:none" />
                        <button class="btn" id="pickRight" type="button">📷 Seleziona file</button>
                        <button class="btn danger" id="clearRight" type="button">Rimuovi</button>
                      </div>
                      <div class="mini">Verrà salvato: <b>${escapeXml(IMAGES_FOLDER)}nomefile.jpg</b></div>
                    </div>
                  </div>

                  <div class="row">
                    <label>Titolo (prima parte)</label>
                    <input id="eHeroPrefix" type="text" value="${escapeXml(c.heroPrefix || "")}" />
                  </div>

                  <div class="row">
                    <label>Titolo (parte oro)</label>
                    <input id="eHeroGold" type="text" value="${escapeXml(c.heroGold || "")}" />
                  </div>

                  <div class="row">
                    <label>Descrizione evento</label>
                    <textarea id="eHeroDesc">${escapeXml(brToNl(String(c.heroDesc || "")))}</textarea>
                  </div>

                  <div class="row">
                    <label>Dettagli serata</label>
                    <textarea id="eToast">${escapeXml(brToNl(String(c.toast || "")))}</textarea>
                  </div>

                  <div class="row">
                    <label>Data & Orario</label>
                    <textarea id="eOrario">${escapeXml(brToNl(String(c.metaOrario || "")))}</textarea>
                  </div>

                  <div class="row">
                    <label>Note</label>
                    <textarea id="eNote">${escapeXml(brToNl(String(c.metaNote || "")))}</textarea>
                  </div>

                  <div class="right">
                    <button class="btn" id="cancelEvent" type="button">Annulla</button>
                    <button class="btn ok" id="saveEvent" type="button">Conferma</button>
                  </div>
                </div>
              `);

            setTimeout(() => {
                const cancel = document.getElementById("cancelEvent");
                const save = document.getElementById("saveEvent");
                if (cancel) cancel.onclick = closeModal;

                let leftValue = String(DRAFT.cover.sideLeftImageUrl || "");
                let rightValue = String(DRAFT.cover.sideRightImageUrl || "");
                let leftPreviewUrl = "";
                let rightPreviewUrl = "";

                let patternValue = String(DRAFT.cover.themePatternUrl || "");
                let patternPreviewUrl = "";

                function revoke(u) { try { if (u) URL.revokeObjectURL(u); } catch { } }

                const pickPattern = document.getElementById("pickPattern");
                const filePattern = document.getElementById("eFilePattern");
                const prevPattern = document.getElementById("prevPattern");
                const clearPattern = document.getElementById("clearPattern");
                const patternUrlInput = document.getElementById("ePatternUrl");
                const patternSizeInput = document.getElementById("ePatternSize");

                const baseBgInput = document.getElementById("eBaseBgColor");
                const baseBgPick = document.getElementById("eBaseBgColorPick");
                const clearBaseBg = document.getElementById("clearBaseBgColor");
                let baseBgValue = String(DRAFT.cover.baseBgColor || "").trim();

                function normalizeHex(v){
                    const s = String(v||"").trim();
                    if (!s) return "";
                    // accetta #RGB o #RRGGBB
                    if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(s)) return s;
                    return "";
                }

// ==========================================================
// ✅ IMAGE OPTIMIZER (evita QuotaExceededError in localStorage)
// Riduce e comprime l'immagine prima di salvarla (WEBP 1024px).
// ==========================================================
function fileToOptimizedDataURL(file, maxDim = 1024, quality = 0.86) {
    return new Promise((resolve) => {
        try {
            const url = URL.createObjectURL(file);
            const img = new Image();
            img.onload = async () => {
                try {
                    const w = img.naturalWidth || img.width;
                    const h = img.naturalHeight || img.height;
                    const scale = Math.min(1, maxDim / Math.max(w, h));
                    const cw = Math.max(1, Math.round(w * scale));
                    const ch = Math.max(1, Math.round(h * scale));

                    const canvas = document.createElement("canvas");
                    canvas.width = cw;
                    canvas.height = ch;
                    const ctx = canvas.getContext("2d", { alpha: true });
                    ctx.clearRect(0, 0, cw, ch);
                    ctx.drawImage(img, 0, 0, cw, ch);

                    const done = (dataUrl) => resolve(String(dataUrl || ""));
                    if (canvas.toBlob) {
                        canvas.toBlob((blob) => {
                            if (!blob) {
                                // fallback
                                try { done(canvas.toDataURL("image/png")); } catch { done(""); }
                                return;
                            }
                            const r = new FileReader();
                            r.onload = () => done(r.result);
                            r.readAsDataURL(blob);
                        }, "image/webp", quality);
                    } else {
                        // fallback vecchi browser
                        try { done(canvas.toDataURL("image/png")); } catch { done(""); }
                    }
                } catch (e) {
                    resolve("");
                } finally {
                    try { URL.revokeObjectURL(url); } catch { }
                }
            };
            img.onerror = () => { try { URL.revokeObjectURL(url); } catch { } resolve(""); };
            img.src = url;
        } catch (e) {
            resolve("");
        }
    });
}


                function syncBaseBgUI(from){
                    const hex = normalizeHex(baseBgValue);
                    if (baseBgInput && from !== "text") baseBgInput.value = baseBgValue;
                    if (baseBgPick && from !== "pick") baseBgPick.value = hex || "#ff7a00";
                }

                syncBaseBgUI();

                if (baseBgInput) {
                    baseBgInput.addEventListener("input", () => {
                        baseBgValue = String(baseBgInput.value || "").trim();
                        syncBaseBgUI("text");
                    });
                }

                if (baseBgPick) {
                    baseBgPick.addEventListener("input", () => {
                        baseBgValue = String(baseBgPick.value || "").trim();
                        syncBaseBgUI("pick");
                    });
                }

                if (clearBaseBg) {
                    clearBaseBg.onclick = () => {
                        baseBgValue = "";
                        syncBaseBgUI();
                    };
                }

                function refreshPatternPreview(src) {
                    prevPattern.src = src ? resolveImageSrc(src, "Tema") : resolveImageSrc("", "Tema");
                }

                if (pickPattern && filePattern) {
                    pickPattern.onclick = () => filePattern.click();
                    filePattern.onchange = async () => {
    const f = filePattern.files && filePattern.files[0];
    if (!f) return;

    // ✅ comprimi prima di salvare (evita che alcune immagini non si vedano per quota storage)
    let dataUrl = await fileToOptimizedDataURL(f, 1024, 0.86);

    // fallback: se per qualche motivo la compressione fallisce
    if (!dataUrl) {
        dataUrl = await new Promise((resolve) => {
            try {
                const rr = new FileReader();
                rr.onload = () => resolve(String(rr.result || ""));
                rr.onerror = () => resolve("");
                rr.readAsDataURL(f);
            } catch { resolve(""); }
        });
    }

    patternValue = String(dataUrl || "");
    prevPattern.src = patternValue || resolveImageSrc("", "Tema");
    if (patternUrlInput) patternUrlInput.value = "";
};

                }
                if (clearPattern) {
                    clearPattern.onclick = () => {
                        revoke(patternPreviewUrl); patternPreviewUrl = "";
                        patternValue = "";
                        if (filePattern) filePattern.value = "";
                        if (patternUrlInput) patternUrlInput.value = "";
                        refreshPatternPreview("");
                    };
                }
                if (patternUrlInput) {
                    patternUrlInput.addEventListener("input", () => {
                        const v = patternUrlInput.value.trim();
                        if (v) {
                            revoke(patternPreviewUrl); patternPreviewUrl = "";
                            patternValue = v;
                            refreshPatternPreview(v);
                        } else {
                            if (patternValue.startsWith("http")) {
                                patternValue = "";
                                refreshPatternPreview("");
                            }
                        }
                    });
                }

                const pickLeft = document.getElementById("pickLeft");
                const fileLeft = document.getElementById("eFileLeft");
                const prevLeft = document.getElementById("prevLeft");
                const clearLeft = document.getElementById("clearLeft");

                if (pickLeft && fileLeft) {
                    pickLeft.onclick = () => fileLeft.click();
                    fileLeft.onchange = async () => {
    const f = fileLeft.files && fileLeft.files[0];
    if (!f) return;

    let dataUrl = await fileToOptimizedDataURL(f, 1024, 0.86);
    if (!dataUrl) {
        dataUrl = await new Promise((resolve) => {
            try {
                const rr = new FileReader();
                rr.onload = () => resolve(String(rr.result || ""));
                rr.onerror = () => resolve("");
                rr.readAsDataURL(f);
            } catch { resolve(""); }
        });
    }

    leftValue = String(dataUrl || "");
    prevLeft.src = leftValue || resolveImageSrc("", "Foto sinistra");
};

                }
                if (clearLeft) {
                    clearLeft.onclick = () => {
                        revoke(leftPreviewUrl); leftPreviewUrl = "";
                        leftValue = "";
                        if (fileLeft) fileLeft.value = "";
                        prevLeft.src = resolveImageSrc("", "Foto sinistra");
                    };
                }

                const pickRight = document.getElementById("pickRight");
                const fileRight = document.getElementById("eFileRight");
                const prevRight = document.getElementById("prevRight");
                const clearRight = document.getElementById("clearRight");

                if (pickRight && fileRight) {
                    pickRight.onclick = () => fileRight.click();
                    fileRight.onchange = async () => {
    const f = fileRight.files && fileRight.files[0];
    if (!f) return;

    let dataUrl = await fileToOptimizedDataURL(f, 1024, 0.86);
    if (!dataUrl) {
        dataUrl = await new Promise((resolve) => {
            try {
                const rr = new FileReader();
                rr.onload = () => resolve(String(rr.result || ""));
                rr.onerror = () => resolve("");
                rr.readAsDataURL(f);
            } catch { resolve(""); }
        });
    }

    rightValue = String(dataUrl || "");
    prevRight.src = rightValue || resolveImageSrc("", "Foto destra");
};

                }
                if (clearRight) {
                    clearRight.onclick = () => {
                        revoke(rightPreviewUrl); rightPreviewUrl = "";
                        rightValue = "";
                        if (fileRight) fileRight.value = "";
                        prevRight.src = resolveImageSrc("", "Foto destra");
                    };
                }

                if (save) save.onclick = () => {
                    const browserTitle = document.getElementById("eBrowserTitle").value.trim();

                    const role1Label = document.getElementById("eRole1Label").value.trim();
                    const role1Name = document.getElementById("eRole1Name").value.trim();
                    const role2Label = document.getElementById("eRole2Label").value.trim();
                    const role2Name = document.getElementById("eRole2Name").value.trim();

                    const heroPrefix = document.getElementById("eHeroPrefix").value.trim();
                    const heroGold = document.getElementById("eHeroGold").value.trim();

                    const heroDesc = document.getElementById("eHeroDesc").value;
                    const toast = document.getElementById("eToast").value;
                    const orario = document.getElementById("eOrario").value;
                    const note = document.getElementById("eNote").value;

                    const sizeVal = Number(patternSizeInput?.value || DEFAULT_DATA.cover.themePatternSize);

                    DRAFT.cover.browserTitle = browserTitle || DEFAULT_DATA.cover.browserTitle;

                    DRAFT.cover.role1Label = role1Label || DEFAULT_DATA.cover.role1Label;
                    DRAFT.cover.role1Name = role1Name || "";

                    DRAFT.cover.role2Label = role2Label || DEFAULT_DATA.cover.role2Label;
                    DRAFT.cover.role2Name = role2Name || "";

                    DRAFT.cover.sideLeftImageUrl = String(leftValue || "").trim();
                    DRAFT.cover.sideRightImageUrl = String(rightValue || "").trim();

                    const urlTyped = (patternUrlInput?.value || "").trim();
                    DRAFT.cover.themePatternUrl = (urlTyped ? urlTyped : String(patternValue || "").trim());
                    DRAFT.cover.themePatternSize = (Number.isFinite(sizeVal) && sizeVal >= 80) ? Math.round(sizeVal) : DEFAULT_DATA.cover.themePatternSize;


                    // ✅ sfondo base custom (opzionale)
                    DRAFT.cover.baseBgColor = String(baseBgValue || "").trim();

                    DRAFT.cover.heroPrefix = heroPrefix || "";
                    DRAFT.cover.heroGold = heroGold || "";

                    DRAFT.cover.heroDesc = String(heroDesc ?? "").replace(/\r\n/g, "\n");
                    DRAFT.cover.toast = String(toast ?? "").replace(/\r\n/g, "\n");
                    DRAFT.cover.metaOrario = String(orario ?? "").replace(/\r\n/g, "\n");
                    DRAFT.cover.metaNote = String(note ?? "").replace(/\r\n/g, "\n");

                    revoke(leftPreviewUrl);
                    revoke(rightPreviewUrl);
                    revoke(patternPreviewUrl);

                    setDirty(true);
                    renderPublic(DRAFT, true);
                    closeModal();
                };
            }, 0);
        }

        /******************************************************************
         * LOGIN
         ******************************************************************/
        function showLogin() {
            openModal("Login Admin", `
                <div class="panel">
                  <div class="row">
                    <label>Username</label>
                    <input id="loginUser" type="text" autocomplete="username" />
                  </div>
                  <div class="row">
                    <label>Password</label>
                    <input id="loginPass" type="password" autocomplete="current-password" />
                  </div>
                  <div class="right">
                    <button class="btn ok" id="doLogin" type="button">Accedi</button>
                  </div>
                </div>
              `);

            setTimeout(() => {
                const btn = document.getElementById("doLogin");
                const u = document.getElementById("loginUser");
                const p = document.getElementById("loginPass");

                function attempt() {
                    const uu = (u.value || "").trim();
                    const pp = (p.value || "").trim();
                    if (uu === ADMIN_USERNAME && pp === ADMIN_PASSWORD) {
                        localStorage.setItem(SESSION_KEY, "1");
                        closeModal();
                        enterAdmin();
                    } else {
                        openModal("Login Admin", `
                      <div class="panel">
                        <b style="letter-spacing:.18em; text-transform:uppercase; font-size:12px;">Credenziali errate</b>
                        <p class="mini">Riprova.</p>
                        <div class="right">
                          <button class="btn ok" id="retryLogin" type="button">Riprova</button>
                        </div>
                      </div>
                    `);
                        setTimeout(() => {
                            const r = document.getElementById("retryLogin");
                            if (r) r.onclick = showLogin;
                        }, 0);
                    }
                }

                if (btn) btn.onclick = attempt;
                if (p) p.addEventListener("keydown", (e) => { if (e.key === "Enter") attempt(); });
            }, 0);
        }

        function enterAdmin() {
            document.body.classList.add("admin");
            $("logoutBtn").style.display = "inline-flex";
            $("saveFloat").style.display = "flex";
            $("editEventBtn").style.display = "inline-flex";

            DRAFT = normalizeMenuData(deepClone(MENU || loadMenuFromLocal()));
            setDirty(false);
            renderPublic(DRAFT, true);
        }

        function exitAdmin() {
            document.body.classList.remove("admin");
            $("logoutBtn").style.display = "none";
            $("saveFloat").style.display = "none";
            $("editEventBtn").style.display = "none";
            setDirty(false);
            DRAFT = null;
            renderPublic(MENU, false);
        }

        /******************************************************************
         * DOWNLOAD JSON
         ******************************************************************/
        function downloadJsonFile(data, filename = "menu-data.json") {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.rel = "noopener";
            a.style.display = "none";
            document.body.appendChild(a);

            const ev = new MouseEvent("click", { bubbles: true, cancelable: true, view: window });
            a.dispatchEvent(ev);

            setTimeout(() => {
                try { a.remove(); } catch { }
                try { URL.revokeObjectURL(url); } catch { }
            }, 600);
        }

        function saveAll() {
            if (!isAdmin() || !DRAFT) return;

            try {
                DRAFT = normalizeMenuData(DRAFT);

                downloadJsonFile(DRAFT, "menu-data.json");

                MENU = deepClone(DRAFT);
                setDirty(false);

                openModal("Salvato", `
                  <div class="panel">
                    <b style="letter-spacing:.18em; text-transform:uppercase; font-size:12px;">Ok ✅</b>
                    <p class="mini">
                      Ho scaricato <b>menu-data.json</b>.<br/><br/>
                      Se hai scelto immagini come file, ricordati di caricarle davvero nella cartella <b>${escapeXml(IMAGES_FOLDER)}</b> su GitHub.
                    </p>
                    <div class="right">
                      <button class="btn ok" id="okClose" type="button">Ok</button>
                    </div>
                  </div>
                `);

                setTimeout(() => {
                    const b = document.getElementById("okClose");
                    if (b) b.onclick = closeModal;
                }, 0);

                renderPublic(DRAFT, true);
            } catch (err) {
                console.error(err);
                openModal("Errore Salvataggio", `
                  <div class="panel">
                    <b style="letter-spacing:.18em; text-transform:uppercase; font-size:12px; color: rgba(255,91,107,.9);">Errore ❌</b>
                    <p class="mini">Apri la console (F12 → Console) e guarda l’errore.</p>
                    <div class="right">
                      <button class="btn ok" id="errClose" type="button">Ok</button>
                    </div>
                  </div>
                `);

                setTimeout(() => {
                    const b = document.getElementById("errClose");
                    if (b) b.onclick = closeModal;
                }, 0);
            }
        }

        /******************************************************************
         * INIT
         ******************************************************************/
        (async function init() {
            $("toggleTheme").addEventListener("click", () => document.body.classList.toggle("light"));
            $("printBtn").addEventListener("click", () => window.print());
            $("modalClose").addEventListener("click", closeModal);

            $("adminBtn").addEventListener("click", () => {
                if (isAdmin()) enterAdmin();
                else showLogin();
            });

            $("logoutBtn").addEventListener("click", () => {
                logout();
                exitAdmin();
            });

            $("saveAllBtn").addEventListener("click", saveAll);

            $("editEventBtn").addEventListener("click", () => {
                if (!isAdmin()) return;
                openEventModal();
            });

            MENU = await loadMenuAsync();
            renderPublic(MENU, false);
            setupThemeScrollMotion();
            relocateSidePortraitsForMobile();
            window.addEventListener('resize', () => { relocateSidePortraitsForMobile(); }, { passive: true });

            window.addEventListener("beforeunload", (e) => {
                if (isAdmin() && DIRTY) {
                    e.preventDefault();
                    e.returnValue = "";
                }
            });
        })();
    </script>
</body>
</html>